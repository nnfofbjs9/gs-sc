<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gradesheet Creator - Admin</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @media print {
            body * {
                visibility: hidden;
            }
            #printable-sheet, #printable-sheet * {
                visibility: visible;
            }
            #printable-sheet {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
            @page {
                size: A4;
                margin: 10mm;
            }
        }

        /* Gradesheet Table Styles */
        .gradesheet-table {
            width: 100%;
            border-collapse: collapse;
            font-family: Arial, sans-serif;
            font-size: 11pt;
            margin-bottom: 15px;
        }
        
        .gradesheet-table th,
        .gradesheet-table td {
            border: 2px solid black;
            padding: 6px;
            text-align: center;
        }
        
        .gradesheet-table th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        
        .gradesheet-table .student-name {
            text-align: left;
            font-weight: bold;
            width: 180px;
        }
        
        .gradesheet-table .id-cell {
            width: 50px;
            font-weight: bold;
        }
        
        .gradesheet-table .grade-cell {
            width: 60px;
            height: 30px;
        }
        
        .header-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 11pt;
        }
        
        .header-table td {
            border: 2px solid black;
            padding: 6px;
            font-weight: bold;
        }
        
        .header-label {
            background-color: #f0f0f0;
        }
        
        .topsheet-title {
            text-align: center;
            font-size: 18pt;
            font-weight: bold;
            margin: 15px 0;
        }
        
        /* Editable cell styles */
        .editable-cell {
            min-height: 30px;
            cursor: text;
        }
        
        .editable-cell:focus {
            outline: 2px solid #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // =====================================================
        // CONFIGURATION
        // =====================================================
        const SUPABASE_URL = 'https://zfkdypxmegocmjontbiz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpma2R5cHhtZWdvY21qb250Yml6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NzM3MDMsImV4cCI6MjA4MTU0OTcwM30.GLwItBWPKW4EZ67wiAPuaKq38DA5WfJ5UYcvPPYsWwI';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // =====================================================
        // ADMIN HEADER COMPONENT
        // =====================================================
        function AdminHeader({ user, onSignOut }) {
            return (
                <header className="bg-gray-800 text-white shadow-sm no-print">
                    <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                        <div className="flex items-center gap-4">
                            <h1 className="text-xl font-bold">Gradesheet Creator</h1>
                            <a 
                                href="/admin.html"
                                className="text-sm text-gray-300 hover:text-white"
                            >
                                ‚Üê Back to Admin
                            </a>
                        </div>
                        <div className="flex items-center gap-4">
                            <span className="text-sm text-gray-300">{user?.email}</span>
                            <button
                                onClick={onSignOut}
                                className="px-3 py-1 text-sm bg-gray-700 rounded hover:bg-gray-600"
                            >
                                Sign Out
                            </button>
                        </div>
                    </div>
                </header>
            );
        }

        // =====================================================
        // GRADESHEET COMPONENT
        // =====================================================
        function GradesheetCreator({ user, teacher }) {
            const [batches, setBatches] = useState([]);
            const [selectedBatch, setSelectedBatch] = useState('');
            const [selectedClass, setSelectedClass] = useState('');
            const [students, setStudents] = useState([]);
            const [activities, setActivities] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [sheetGenerated, setSheetGenerated] = useState(false);
            
            // Sheet metadata
            const [version, setVersion] = useState('V1');
            const [level, setLevel] = useState('');
            const [classNumber, setClassNumber] = useState('');
            const [batchCode, setBatchCode] = useState('');

            useEffect(() => {
                fetchBatches();
            }, []);

            const fetchBatches = async () => {
                try {
                    const { data, error } = await supabase
                        .from('batches')
                        .select('batch_id, batch_name, level, batch_code, center_id, centers(center_name)')
                        .eq('is_active', true)
                        .order('batch_name');

                    if (error) throw error;
                    setBatches(data || []);
                } catch (err) {
                    console.error('Error fetching batches:', err);
                    setError('Failed to load batches');
                }
            };

            const handleBatchChange = (batchId) => {
                setSelectedBatch(batchId);
                setSheetGenerated(false);
                const batch = batches.find(b => b.batch_id === batchId);
                if (batch) {
                    setLevel(batch.level?.toString() || '');
                    setBatchCode(batch.batch_code || '');
                }
            };

            const generateSheet = async () => {
                if (!selectedBatch || !selectedClass) {
                    setError('Please select both batch and class number');
                    return;
                }

                setLoading(true);
                setError('');

                try {
                    // Fetch students for the batch
                    const { data: studentsData, error: studentsError } = await supabase
                        .from('students')
                        .select('student_id, student_name, center_student_id')
                        .eq('batch_id', selectedBatch)
                        .eq('is_active', true)
                        .order('center_student_id');

                    if (studentsError) throw studentsError;

                    // Fetch activities for the class
                    const { data: activitiesData, error: activitiesError } = await supabase
                        .from('activities')
                        .select('activity_id, activity_name, sequence_in_class')
                        .eq('level', parseInt(level))
                        .eq('class_number', parseInt(selectedClass))
                        .eq('is_active', true)
                        .order('sequence_in_class');

                    if (activitiesError) throw activitiesError;

                    if (!studentsData || studentsData.length === 0) {
                        setError('No active students found for this batch');
                        return;
                    }

                    if (!activitiesData || activitiesData.length === 0) {
                        setError('No activities found for this level and class');
                        return;
                    }

                    if (activitiesData.length > 10) {
                        setError('Maximum 10 activities supported. Please adjust activities for this class.');
                        return;
                    }

                    setStudents(studentsData);
                    setActivities(activitiesData);
                    setClassNumber(selectedClass);
                    setSheetGenerated(true);

                } catch (err) {
                    console.error('Error generating sheet:', err);
                    setError('Failed to generate gradesheet: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handlePrint = () => {
                window.print();
            };

            const handleCellEdit = (e) => {
                // Allow inline editing
                e.target.contentEditable = true;
            };

            // Split activities into two tables for better OCR
            const midPoint = Math.ceil(activities.length / 2);
            const firstHalfActivities = activities.slice(0, midPoint);
            const secondHalfActivities = activities.slice(midPoint);

            return (
                <div className="min-h-screen bg-gray-100">
                    {/* Controls Section */}
                    <div className="max-w-7xl mx-auto px-4 py-6 no-print">
                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h2 className="text-2xl font-bold mb-4">Generate Gradesheet</h2>
                            
                            {error && (
                                <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                                    {error}
                                </div>
                            )}

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Select Batch
                                    </label>
                                    <select
                                        value={selectedBatch}
                                        onChange={(e) => handleBatchChange(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="">Choose a batch...</option>
                                        {batches.map(batch => (
                                            <option key={batch.batch_id} value={batch.batch_id}>
                                                {batch.batch_name} - Level {batch.level} ({batch.centers?.center_name})
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Class Number (1-36)
                                    </label>
                                    <input
                                        type="number"
                                        min="1"
                                        max="36"
                                        value={selectedClass}
                                        onChange={(e) => {
                                            setSelectedClass(e.target.value);
                                            setSheetGenerated(false);
                                        }}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder="Enter class number"
                                    />
                                </div>

                                <div className="flex items-end">
                                    <button
                                        onClick={generateSheet}
                                        disabled={loading || !selectedBatch || !selectedClass}
                                        className="w-full px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                                    >
                                        {loading ? 'Generating...' : 'Generate Sheet'}
                                    </button>
                                </div>
                            </div>

                            {sheetGenerated && (
                                <div className="flex gap-4">
                                    <button
                                        onClick={handlePrint}
                                        className="px-6 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700"
                                    >
                                        üñ®Ô∏è Print Sheet
                                    </button>
                                    <div className="text-sm text-gray-600 flex items-center">
                                        ‚ÑπÔ∏è Sheet is editable - click any cell to modify before printing
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Printable Sheet */}
                    {sheetGenerated && (
                        <div id="printable-sheet" className="bg-white max-w-[210mm] mx-auto p-8">
                            {/* Header Table */}
                            <table className="header-table">
                                <tbody>
                                    <tr>
                                        <td 
                                            className="editable-cell"
                                            contentEditable
                                            suppressContentEditableWarning
                                        >
                                            {version}
                                        </td>
                                        <td className="header-label">Level:</td>
                                        <td 
                                            className="editable-cell"
                                            contentEditable
                                            suppressContentEditableWarning
                                        >
                                            {level}
                                        </td>
                                        <td className="header-label">Class:</td>
                                        <td 
                                            className="editable-cell"
                                            contentEditable
                                            suppressContentEditableWarning
                                        >
                                            {classNumber}
                                        </td>
                                        <td className="header-label">Batch Code:</td>
                                        <td 
                                            className="editable-cell"
                                            contentEditable
                                            suppressContentEditableWarning
                                        >
                                            {batchCode}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            {/* Title */}
                            <div className="topsheet-title">Class Topsheet</div>

                            {/* First Table */}
                            <table className="gradesheet-table">
                                <thead>
                                    <tr>
                                        <th className="id-cell">ID</th>
                                        <th className="student-name">Student Name</th>
                                        {firstHalfActivities.map((activity, idx) => (
                                            <th key={activity.activity_id} className="grade-cell">
                                                <div 
                                                    contentEditable
                                                    suppressContentEditableWarning
                                                    className="editable-cell"
                                                >
                                                    Activity {idx + 1}
                                                </div>
                                            </th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {students.map((student, studentIdx) => (
                                        <tr key={student.student_id}>
                                            <td className="id-cell">
                                                <div 
                                                    contentEditable
                                                    suppressContentEditableWarning
                                                    className="editable-cell"
                                                >
                                                    {student.center_student_id || studentIdx + 1}
                                                </div>
                                            </td>
                                            <td className="student-name">
                                                <div 
                                                    contentEditable
                                                    suppressContentEditableWarning
                                                    className="editable-cell"
                                                >
                                                    {student.student_name}
                                                </div>
                                            </td>
                                            {firstHalfActivities.map((activity) => (
                                                <td 
                                                    key={activity.activity_id}
                                                    className="grade-cell editable-cell"
                                                    contentEditable
                                                    suppressContentEditableWarning
                                                >
                                                </td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>

                            {/* Second Table (if there are activities in second half) */}
                            {secondHalfActivities.length > 0 && (
                                <table className="gradesheet-table">
                                    <thead>
                                        <tr>
                                            <th className="id-cell">ID</th>
                                            <th className="student-name">Student Name</th>
                                            {secondHalfActivities.map((activity, idx) => (
                                                <th key={activity.activity_id} className="grade-cell">
                                                    <div 
                                                        contentEditable
                                                        suppressContentEditableWarning
                                                        className="editable-cell"
                                                    >
                                                        Activity {firstHalfActivities.length + idx + 1}
                                                    </div>
                                                </th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {students.map((student, studentIdx) => (
                                            <tr key={student.student_id}>
                                                <td className="id-cell">
                                                    <div 
                                                        contentEditable
                                                        suppressContentEditableWarning
                                                        className="editable-cell"
                                                    >
                                                        {student.center_student_id || studentIdx + 1}
                                                    </div>
                                                </td>
                                                <td className="student-name">
                                                    <div 
                                                        contentEditable
                                                        suppressContentEditableWarning
                                                        className="editable-cell"
                                                    >
                                                        {student.student_name}
                                                    </div>
                                                </td>
                                                {secondHalfActivities.map((activity) => (
                                                    <td 
                                                        key={activity.activity_id}
                                                        className="grade-cell editable-cell"
                                                        contentEditable
                                                        suppressContentEditableWarning
                                                    >
                                                    </td>
                                                ))}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        // =====================================================
        // ACCESS DENIED COMPONENT
        // =====================================================
        function AccessDenied() {
            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full text-center">
                        <div className="text-6xl mb-4">üîí</div>
                        <h1 className="text-2xl font-bold text-gray-800 mb-2">Access Denied</h1>
                        <p className="text-gray-600 mb-6">
                            This page is only accessible to site administrators.
                        </p>
                        <a
                            href="/admin.html"
                            className="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition"
                        >
                            Back to Admin Panel
                        </a>
                    </div>
                </div>
            );
        }

        // =====================================================
        // LOGIN PROMPT COMPONENT
        // =====================================================
        function LoginPrompt() {
            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full text-center">
                        <h1 className="text-2xl font-bold text-gray-800 mb-2">Login Required</h1>
                        <p className="text-gray-600 mb-6">
                            Please sign in through the main app first.
                        </p>
                        <a
                            href="/"
                            className="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition"
                        >
                            Go to Login
                        </a>
                    </div>
                </div>
            );
        }

        // =====================================================
        // MAIN APP COMPONENT
        // =====================================================
        function App() {
            const [user, setUser] = useState(null);
            const [teacher, setTeacher] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                checkAuth();
            }, []);

            const checkAuth = async () => {
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    
                    if (session?.user) {
                        setUser(session.user);
                        
                        // Check if user is site_admin
                        const { data: teacherData, error } = await supabase
                            .from('teachers')
                            .select('*')
                            .eq('teacher_id', session.user.id)
                            .single();

                        if (!error && teacherData) {
                            setTeacher(teacherData);
                        }
                    }
                } catch (err) {
                    console.error('Auth check error:', err);
                } finally {
                    setLoading(false);
                }
            };

            const handleSignOut = async () => {
                await supabase.auth.signOut();
                window.location.href = '/';
            };

            // Loading
            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent"></div>
                            <p className="mt-4 text-gray-600">Loading...</p>
                        </div>
                    </div>
                );
            }

            // Not logged in
            if (!user) {
                return <LoginPrompt />;
            }

            // Not site_admin
            if (!teacher || teacher.role !== 'site_admin') {
                return <AccessDenied />;
            }

            // Gradesheet Creator
            return (
                <div>
                    <AdminHeader user={user} onSignOut={handleSignOut} />
                    <GradesheetCreator user={user} teacher={teacher} />
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
