<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gradesheet Scanner</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // =====================================================
        // CONFIGURATION
        // =====================================================
        const SUPABASE_URL = 'https://zfkdypxmegocmjontbiz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpma2R5cHhtZWdvY21qb250Yml6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NzM3MDMsImV4cCI6MjA4MTU0OTcwM30.GLwItBWPKW4EZ67wiAPuaKq38DA5WfJ5UYcvPPYsWwI';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // =====================================================
        // INPUT SANITIZATION UTILITIES
        // =====================================================
        // Reject strings containing characters commonly used in SQL injection or XSS
        const DANGEROUS_PATTERN = /[<>{}();'"\\\/\-\-]|(\b(SELECT|INSERT|UPDATE|DELETE|DROP|UNION|ALTER|EXEC|SCRIPT)\b)/i;

        function sanitizeText(value) {
            if (typeof value !== 'string') return '';
            return value.trim().replace(/\s+/g, ' ');
        }

        function validateSafeInput(value, fieldName) {
            const trimmed = sanitizeText(value);
            if (DANGEROUS_PATTERN.test(trimmed)) {
                throw new Error(`${fieldName} contains disallowed characters. Please remove any special characters like < > { } ( ) ; ' " \\ / --`);
            }
            return trimmed;
        }

        function validateEmail(value) {
            const trimmed = sanitizeText(value);
            if (!trimmed) return '';
            const emailRegex = /^[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}$/;
            if (!emailRegex.test(trimmed)) {
                throw new Error('Please enter a valid email address.');
            }
            if (DANGEROUS_PATTERN.test(trimmed.replace(/@/g, '').replace(/\./g, ''))) {
                throw new Error('Email contains disallowed characters.');
            }
            return trimmed;
        }

        function validatePhone(value) {
            const trimmed = sanitizeText(value);
            if (!trimmed) return '';
            const phoneRegex = /^[+]?[\d\s\-().]{7,20}$/;
            if (!phoneRegex.test(trimmed)) {
                throw new Error('Please enter a valid phone number.');
            }
            return trimmed;
        }

        function validateName(value, fieldName) {
            const trimmed = sanitizeText(value);
            if (!trimmed) throw new Error(`${fieldName} is required.`);
            if (trimmed.length < 2) throw new Error(`${fieldName} must be at least 2 characters.`);
            if (trimmed.length > 100) throw new Error(`${fieldName} must be less than 100 characters.`);
            const nameRegex = /^[a-zA-Z\s.]+$/;
            if (!nameRegex.test(trimmed)) {
                throw new Error(`${fieldName} can only contain letters, spaces, and periods.`);
            }
            return trimmed;
        }

        // =====================================================
        // ADMIN HEADER COMPONENT
        // =====================================================
        function AdminHeader({ user, onSignOut }) {
            return (
                <header className="bg-gray-800 text-white shadow-sm">
                    <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                        <div className="flex items-center gap-4">
                            <h1 className="text-xl font-bold">Admin Panel</h1>
                            <a 
                                href="/"
                                className="text-sm text-gray-300 hover:text-white"
                            >
                                ‚Üê Back to App
                            </a>
                        </div>
                        <div className="flex items-center gap-4">
                            <span className="text-sm text-gray-300">{user?.email}</span>
                            <button
                                onClick={onSignOut}
                                className="px-3 py-1 text-sm bg-gray-700 rounded hover:bg-gray-600"
                            >
                                Sign Out
                            </button>
                        </div>
                    </div>
                </header>
            );
        }

        // =====================================================
        // ACCESS DENIED COMPONENT
        // =====================================================
        function AccessDenied() {
            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full text-center">
                        <div className="text-6xl mb-4">üîí</div>
                        <h1 className="text-2xl font-bold text-gray-800 mb-2">Access Denied</h1>
                        <p className="text-gray-600 mb-6">
                            This page is only accessible to administrators.
                        </p>
                        <a
                            href="/"
                            className="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition"
                        >
                            Go to Main App
                        </a>
                    </div>
                </div>
            );
        }

        // =====================================================
        // LOGIN PROMPT COMPONENT
        // =====================================================
        function LoginPrompt() {
            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full text-center">
                        <h1 className="text-2xl font-bold text-gray-800 mb-2">Admin Login Required</h1>
                        <p className="text-gray-600 mb-6">
                            Please sign in through the main app first.
                        </p>
                        <a
                            href="/"
                            className="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition"
                        >
                            Go to Login
                        </a>
                    </div>
                </div>
            );
        }

        // =====================================================
        // ACTIVITY MANAGEMENT COMPONENT
        // =====================================================
        function ActivityManagement() {
            const [activities, setActivities] = useState([]);
            const [learningAreas, setLearningAreas] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            
            // Form state
            const [showForm, setShowForm] = useState(false);
            const [formData, setFormData] = useState({
                activity_name: '',
                learning_area_id: '',
                level: 1,
                class_number: null,
                sequence_in_class: null,
                description: ''
            });
            const [saving, setSaving] = useState(false);

            // Filter state
            const [filterLevel, setFilterLevel] = useState('');
            const [filterClass, setFilterClass] = useState('');

            useEffect(() => {
                loadData();
            }, []);

            const loadData = async () => {
                try {
                    // Load learning areas
                    const { data: learningAreasData, error: learningAreasError } = await supabase
                        .from('learning_areas')
                        .select('*')
                        .order('display_order');

                    if (learningAreasError) throw learningAreasError;
                    setLearningAreas(learningAreasData || []);

                    if (learningAreasData?.length > 0) {
                        setFormData(prev => ({ ...prev, learning_area_id: learningAreasData[0].learning_area_id }));
                    }

                    // Load activities
                    const { data: activitiesData, error: activitiesError } = await supabase
                        .from('activities')
                        .select('*, learning_areas(learning_area_name)')
                        .order('level')
                        .order('class_number', { nullsFirst: false })
                        .order('sequence_in_class', { nullsFirst: false })
                        .order('activity_name');
                    
                    if (activitiesError) throw activitiesError;
                    setActivities(activitiesData || []);
                } catch (err) {
                    setError('Failed to load data: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');
                setSaving(true);

                try {
                    const cleanName = validateSafeInput(formData.activity_name, 'Activity name');
                    const cleanDesc = formData.description ? validateSafeInput(formData.description, 'Description') : '';

                    const classNumberValue = formData.class_number ? parseInt(formData.class_number) : null;
                    const sequenceValue = formData.sequence_in_class ? parseInt(formData.sequence_in_class) : null;

                    const { data, error } = await supabase
                        .from('activities')
                        .insert({
                            activity_name: cleanName,
                            learning_area_id: formData.learning_area_id,
                            level: parseInt(formData.level),
                            class_number: classNumberValue,
                            sequence_in_class: sequenceValue,
                            description: cleanDesc
                        })
                        .select('*, learning_areas(learning_area_name)')
                        .single();

                    if (error) throw error;

                    setActivities([...activities, data]);
                    setSuccess('Activity added successfully!');
                    setFormData({
                        activity_name: '',
                        learning_area_id: learningAreas[0]?.learning_area_id || '',
                        level: 1,
                        class_number: null,
                        sequence_in_class: null,
                        description: ''
                    });
                    setShowForm(false);
                } catch (err) {
                    setError('Failed to add activity: ' + err.message);
                } finally {
                    setSaving(false);
                }
            };

            const deleteActivity = async (activityId, activityName) => {
                if (!confirm(`Are you sure you want to delete "${activityName}"?`)) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('activities')
                        .delete()
                        .eq('activity_id', activityId);

                    if (error) throw error;

                    setActivities(activities.filter(a => a.activity_id !== activityId));
                    setSuccess('Activity deleted successfully!');
                } catch (err) {
                    setError('Failed to delete activity: ' + err.message);
                }
            };

            if (loading) {
                return (
                    <div className="text-center py-12">
                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-600 border-t-transparent"></div>
                        <p className="mt-2 text-gray-600">Loading activities...</p>
                    </div>
                );
            }

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">Activities</h2>
                            <p className="text-gray-600">{activities.length} activities in the system</p>
                        </div>
                        <button
                            onClick={() => setShowForm(true)}
                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                        >
                            + Add Activity
                        </button>
                    </div>

                    {error && (
                        <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-4">
                            {error}
                            <button onClick={() => setError('')} className="float-right font-bold">√ó</button>
                        </div>
                    )}

                    {success && (
                        <div className="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg mb-4">
                            {success}
                            <button onClick={() => setSuccess('')} className="float-right font-bold">√ó</button>
                        </div>
                    )}

                    {/* Add Activity Form */}
                    {showForm && (
                        <div className="bg-white rounded-lg shadow p-6 mb-6">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4">Add New Activity</h3>
                            <form onSubmit={handleSubmit}>
                                <div className="grid gap-4 md:grid-cols-2">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Activity Name *
                                        </label>
                                        <input
                                            type="text"
                                            value={formData.activity_name}
                                            onChange={(e) => setFormData({ ...formData, activity_name: e.target.value })}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                            placeholder="e.g., Counting Beads"
                                            required
                                            maxLength={100}
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Learning Area *
                                        </label>
                                        <select
                                            value={formData.learning_area_id}
                                            onChange={(e) => setFormData({ ...formData, learning_area_id: e.target.value })}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                            required
                                        >
                                            {learningAreas.map(la => (
                                                <option key={la.learning_area_id} value={la.learning_area_id}>
                                                    {la.learning_area_name}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Level *
                                        </label>
                                        <select
                                            value={formData.level}
                                            onChange={(e) => setFormData({ ...formData, level: e.target.value })}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                            required
                                        >
                                            {[1, 2, 3, 4, 5].map(level => (
                                                <option key={level} value={level}>
                                                    Level {level}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Class Number (optional)
                                        </label>
                                        <input
                                            type="number"
                                            value={formData.class_number || ''}
                                            onChange={(e) => setFormData({ ...formData, class_number: e.target.value || null })}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                            placeholder="1-36"
                                            min={1}
                                            max={36}
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Position in Class (optional)
                                        </label>
                                        <input
                                            type="number"
                                            value={formData.sequence_in_class || ''}
                                            onChange={(e) => setFormData({ ...formData, sequence_in_class: e.target.value || null })}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                            placeholder="1, 2, 3..."
                                            min={1}
                                        />
                                    </div>

                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Description
                                        </label>
                                        <textarea
                                            value={formData.description}
                                            onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                            placeholder="Brief description of the activity..."
                                            rows={2}
                                            maxLength={500}
                                        />
                                    </div>
                                </div>

                                <div className="mt-4 flex gap-3">
                                    <button
                                        type="submit"
                                        disabled={saving}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition"
                                    >
                                        {saving ? 'Adding...' : 'Add Activity'}
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setShowForm(false)}
                                        className="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-100 transition"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    {/* Filters */}
                    <div className="flex gap-4 mb-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Filter by Level</label>
                            <select
                                value={filterLevel}
                                onChange={(e) => setFilterLevel(e.target.value)}
                                className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">All Levels</option>
                                {[1, 2, 3, 4, 5].map(level => (
                                    <option key={level} value={level}>Level {level}</option>
                                ))}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Filter by Class</label>
                            <select
                                value={filterClass}
                                onChange={(e) => setFilterClass(e.target.value)}
                                className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">All Classes</option>
                                <option value="none">No Class</option>
                                {Array.from({ length: 36 }, (_, i) => i + 1).map(s => (
                                    <option key={s} value={s}>Class {s}</option>
                                ))}
                            </select>
                        </div>
                    </div>

                    {/* Activities Table */}
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <table className="w-full">
                            <thead className="bg-gray-100">
                                <tr>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Activity</th>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Learning Area</th>
                                    <th className="px-4 py-3 text-center text-sm font-semibold text-gray-700">Level</th>
                                    <th className="px-4 py-3 text-center text-sm font-semibold text-gray-700">Class #</th>
                                    <th className="px-4 py-3 text-center text-sm font-semibold text-gray-700">Position</th>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Description</th>
                                    <th className="px-4 py-3 text-center text-sm font-semibold text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                                {activities.filter(a => {
                                    if (filterLevel && a.level !== parseInt(filterLevel)) return false;
                                    if (filterClass === 'none' && a.class_number !== null) return false;
                                    if (filterClass && filterClass !== 'none' && a.class_number !== parseInt(filterClass)) return false;
                                    return true;
                                }).map(activity => (
                                    <tr key={activity.activity_id} className="hover:bg-gray-50">
                                        <td className="px-4 py-3 font-medium text-gray-800">
                                            {activity.activity_name}
                                        </td>
                                        <td className="px-4 py-3 text-gray-600">
                                            {activity.learning_areas?.learning_area_name || '-'}
                                        </td>
                                        <td className="px-4 py-3 text-center">
                                            <span className="px-2 py-1 bg-blue-100 text-blue-700 text-sm rounded">
                                                {activity.level}
                                            </span>
                                        </td>
                                        <td className="px-4 py-3 text-center">
                                            <span className={`px-2 py-1 text-sm rounded ${activity.class_number ? 'bg-purple-100 text-purple-700' : 'text-gray-400'}`}>
                                                {activity.class_number || '-'}
                                            </span>
                                        </td>
                                        <td className="px-4 py-3 text-center">
                                            <span className={`px-2 py-1 text-sm rounded ${activity.sequence_in_class ? 'bg-green-100 text-green-700' : 'text-gray-400'}`}>
                                                {activity.sequence_in_class || '-'}
                                            </span>
                                        </td>
                                        <td className="px-4 py-3 text-gray-600 text-sm max-w-xs truncate">
                                            {activity.description || '-'}
                                        </td>
                                        <td className="px-4 py-3 text-center">
                                            <button
                                                onClick={() => deleteActivity(activity.activity_id, activity.activity_name)}
                                                className="text-red-600 hover:text-red-800 text-sm"
                                            >
                                                Delete
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>

                        {activities.length === 0 && (
                            <div className="text-center py-8 text-gray-500">
                                No activities yet. Add your first activity above.
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // =====================================================
        // CENTER MANAGEMENT COMPONENT
        // =====================================================
        function CenterManagement() {
            const [centers, setCenters] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            
            const [showForm, setShowForm] = useState(false);
            const [formData, setFormData] = useState({
                center_name: '',
                location: '',
                contact_email: '',
                contact_phone: ''
            });
            const [saving, setSaving] = useState(false);

            useEffect(() => {
                loadCenters();
            }, []);

            const loadCenters = async () => {
                try {
                    const { data, error } = await supabase
                        .from('centers')
                        .select('*')
                        .order('center_name');
                    
                    if (error) throw error;
                    setCenters(data || []);
                } catch (err) {
                    setError('Failed to load centers: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');
                setSaving(true);

                try {
                    const cleanCenterName = validateSafeInput(formData.center_name, 'Center name');
                    const cleanLocation = validateSafeInput(formData.location, 'Location');
                    const cleanEmail = formData.contact_email ? validateEmail(formData.contact_email) : null;
                    const cleanPhone = formData.contact_phone ? validatePhone(formData.contact_phone) : null;

                    const { data, error } = await supabase
                        .from('centers')
                        .insert({
                            center_name: cleanCenterName,
                            location: cleanLocation,
                            contact_email: cleanEmail,
                            contact_phone: cleanPhone
                        })
                        .select()
                        .single();

                    if (error) throw error;

                    setCenters([...centers, data]);
                    setSuccess('Center added successfully!');
                    setFormData({ center_name: '', location: '', contact_email: '', contact_phone: '' });
                    setShowForm(false);
                } catch (err) {
                    setError('Failed to add center: ' + err.message);
                } finally {
                    setSaving(false);
                }
            };

            if (loading) {
                return (
                    <div className="text-center py-12">
                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-600 border-t-transparent"></div>
                        <p className="mt-2 text-gray-600">Loading centers...</p>
                    </div>
                );
            }

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">Centers</h2>
                            <p className="text-gray-600">{centers.length} centers in the system</p>
                        </div>
                        <button
                            onClick={() => setShowForm(true)}
                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                        >
                            + Add Center
                        </button>
                    </div>

                    {error && (
                        <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-4">
                            {error}
                            <button onClick={() => setError('')} className="float-right font-bold">√ó</button>
                        </div>
                    )}

                    {success && (
                        <div className="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg mb-4">
                            {success}
                            <button onClick={() => setSuccess('')} className="float-right font-bold">√ó</button>
                        </div>
                    )}

                    {showForm && (
                        <div className="bg-white rounded-lg shadow p-6 mb-6">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4">Add New Center</h3>
                            <form onSubmit={handleSubmit}>
                                <div className="grid gap-4 md:grid-cols-2">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Center Name *
                                        </label>
                                        <input
                                            type="text"
                                            value={formData.center_name}
                                            onChange={(e) => setFormData({ ...formData, center_name: e.target.value })}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                            placeholder="e.g., Downtown Center"
                                            required
                                            maxLength={100}
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Location *
                                        </label>
                                        <input
                                            type="text"
                                            value={formData.location}
                                            onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                            placeholder="e.g., Mumbai"
                                            required
                                            maxLength={100}
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Contact Email
                                        </label>
                                        <input
                                            type="email"
                                            value={formData.contact_email}
                                            onChange={(e) => setFormData({ ...formData, contact_email: e.target.value })}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                            placeholder="center@example.com"
                                            maxLength={100}
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Contact Phone
                                        </label>
                                        <input
                                            type="tel"
                                            value={formData.contact_phone}
                                            onChange={(e) => setFormData({ ...formData, contact_phone: e.target.value })}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                            placeholder="+91 99999 99999"
                                            maxLength={20}
                                        />
                                    </div>
                                </div>

                                <div className="mt-4 flex gap-3">
                                    <button
                                        type="submit"
                                        disabled={saving}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition"
                                    >
                                        {saving ? 'Adding...' : 'Add Center'}
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setShowForm(false)}
                                        className="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-100 transition"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                        {centers.map(center => (
                            <div key={center.center_id} className="bg-white rounded-lg shadow p-4">
                                <h3 className="font-semibold text-gray-800">{center.center_name}</h3>
                                <p className="text-sm text-gray-600">{center.location}</p>
                                {center.contact_email && (
                                    <p className="text-sm text-gray-500 mt-2">{center.contact_email}</p>
                                )}
                                {center.contact_phone && (
                                    <p className="text-sm text-gray-500">{center.contact_phone}</p>
                                )}
                                <div className="mt-2">
                                    <span className={`px-2 py-1 text-xs rounded ${center.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}`}>
                                        {center.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                </div>
                            </div>
                        ))}
                    </div>

                    {centers.length === 0 && (
                        <div className="bg-white rounded-lg shadow p-8 text-center text-gray-500">
                            No centers yet. Add your first center above.
                        </div>
                    )}
                </div>
            );
        }

        // =====================================================
        // TEACHER MANAGEMENT COMPONENT
        // =====================================================
        function TeacherManagement() {
            const [teachers, setTeachers] = useState([]);
            const [centers, setCenters] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            useEffect(() => {
                loadData();
            }, []);

            const loadData = async () => {
                try {
                    const { data: teachersData, error: teachersError } = await supabase
                        .from('teachers')
                        .select('*, teacher_centers(center_id, centers(center_name))')
                        .neq('role', 'site_admin')
                        .order('teacher_name');
                    
                    if (teachersError) throw teachersError;
                    setTeachers(teachersData || []);

                    const { data: centersData } = await supabase
                        .from('centers')
                        .select('*')
                        .eq('is_active', true);
                    setCenters(centersData || []);
                } catch (err) {
                    setError('Failed to load data: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const updateRole = async (teacherId, newRole) => {
                try {
                    const { error } = await supabase
                        .from('teachers')
                        .update({ role: newRole })
                        .eq('teacher_id', teacherId);

                    if (error) throw error;

                    setTeachers(teachers.map(t => 
                        t.teacher_id === teacherId ? { ...t, role: newRole } : t
                    ));
                    setSuccess('Role updated successfully!');
                } catch (err) {
                    setError('Failed to update role: ' + err.message);
                }
            };

            const assignToCenter = async (teacherId, centerId) => {
                try {
                    const { error } = await supabase
                        .from('teacher_centers')
                        .insert({ teacher_id: teacherId, center_id: centerId });

                    if (error) throw error;
                    
                    loadData(); // Reload to get updated associations
                    setSuccess('Teacher assigned to center!');
                } catch (err) {
                    if (err.message.includes('duplicate')) {
                        setError('Teacher is already assigned to this center');
                    } else {
                        setError('Failed to assign: ' + err.message);
                    }
                }
            };

            if (loading) {
                return (
                    <div className="text-center py-12">
                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-600 border-t-transparent"></div>
                        <p className="mt-2 text-gray-600">Loading teachers...</p>
                    </div>
                );
            }

            return (
                <div>
                    <div className="mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">Teachers</h2>
                        <p className="text-gray-600">{teachers.length} teachers in the system</p>
                    </div>

                    {error && (
                        <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-4">
                            {error}
                            <button onClick={() => setError('')} className="float-right font-bold">√ó</button>
                        </div>
                    )}

                    {success && (
                        <div className="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg mb-4">
                            {success}
                            <button onClick={() => setSuccess('')} className="float-right font-bold">√ó</button>
                        </div>
                    )}

                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <table className="w-full">
                            <thead className="bg-gray-100">
                                <tr>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Name</th>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Email</th>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Role</th>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Centers</th>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Assign to Center</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                                {teachers.map(teacher => (
                                    <tr key={teacher.teacher_id} className="hover:bg-gray-50">
                                        <td className="px-4 py-3 font-medium text-gray-800">
                                            {teacher.teacher_name}
                                        </td>
                                        <td className="px-4 py-3 text-gray-600">
                                            {teacher.email}
                                        </td>
                                        <td className="px-4 py-3">
                                            <select
                                                value={teacher.role}
                                                onChange={(e) => updateRole(teacher.teacher_id, e.target.value)}
                                                className={`px-2 py-1 text-sm rounded border ${
                                                    teacher.role === 'admin' ? 'bg-purple-100 border-purple-300' :
                                                    teacher.role === 'coordinator' ? 'bg-blue-100 border-blue-300' :
                                                    'bg-gray-100 border-gray-300'
                                                }`}
                                            >
                                                <option value="teacher">Teacher</option>
                                                <option value="coordinator">Coordinator</option>
                                                <option value="admin">Admin</option>
                                            </select>
                                        </td>
                                        <td className="px-4 py-3 text-gray-600 text-sm">
                                            {teacher.teacher_centers?.map(tc => tc.centers?.center_name).join(', ') || '-'}
                                        </td>
                                        <td className="px-4 py-3">
                                            <select
                                                onChange={(e) => {
                                                    if (e.target.value) {
                                                        assignToCenter(teacher.teacher_id, e.target.value);
                                                        e.target.value = '';
                                                    }
                                                }}
                                                className="px-2 py-1 text-sm border border-gray-300 rounded"
                                                defaultValue=""
                                            >
                                                <option value="">+ Add to center</option>
                                                {centers.map(c => (
                                                    <option key={c.center_id} value={c.center_id}>
                                                        {c.center_name}
                                                    </option>
                                                ))}
                                            </select>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // =====================================================
        // STUDENT & PARENT MANAGEMENT COMPONENT
        // =====================================================
        function StudentManagement({ user, teacher }) {
            const [students, setStudents] = useState([]);
            const [parents, setParents] = useState([]);
            const [batches, setBatches] = useState([]);
            const [centers, setCenters] = useState([]);
            const [selectedCenterId, setSelectedCenterId] = useState('');
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            // Enrollment form state
            const [showEnrollForm, setShowEnrollForm] = useState(false);
            const [saving, setSaving] = useState(false);
            const [parentMode, setParentMode] = useState('new'); // 'new' or 'existing'
            const [selectedParentId, setSelectedParentId] = useState('');
            const [parentForm, setParentForm] = useState({
                parent_name: '',
                email: '',
                phone: '',
                relationship_type: 'parent',
                preferred_contact: 'email'
            });
            const [studentForm, setStudentForm] = useState({
                student_name: '',
                date_of_birth: '',
                batch_id: '',
                notes: ''
            });

            // Edit state
            const [editingStudent, setEditingStudent] = useState(null);
            const [editForm, setEditForm] = useState({});

            useEffect(() => {
                loadData();
            }, []);

            const loadData = async () => {
                try {
                    const isSiteAdmin = teacher?.role === 'site_admin';

                    const [studentsRes, parentsRes, batchesRes] = await Promise.all([
                        supabase.from('students').select('*, parents(parent_name, email, phone), batches(batch_name, batch_code)').order('student_name'),
                        supabase.from('parents').select('*').order('parent_name'),
                        supabase.from('batches').select('*, centers(center_name)').eq('is_active', true).order('batch_name')
                    ]);

                    if (studentsRes.error) throw studentsRes.error;
                    if (parentsRes.error) throw parentsRes.error;
                    if (batchesRes.error) throw batchesRes.error;

                    setStudents(studentsRes.data || []);
                    setParents(parentsRes.data || []);
                    setBatches(batchesRes.data || []);

                    // Load centers: site_admin sees all, others see only their assigned centers
                    let centersData = [];
                    if (isSiteAdmin) {
                        const { data, error: cErr } = await supabase
                            .from('centers')
                            .select('*')
                            .eq('is_active', true)
                            .order('center_name');
                        if (!cErr && data) centersData = data;
                    } else {
                        const { data: tcData } = await supabase
                            .from('teacher_centers')
                            .select('center_id, centers(center_id, center_name, is_active)')
                            .eq('teacher_id', user.id);
                        if (tcData) {
                            centersData = tcData
                                .map(tc => tc.centers)
                                .filter(c => c && c.is_active);
                        }
                    }
                    setCenters(centersData);

                    // Auto-select center if only one available
                    const autoCenter = centersData.length === 1 ? centersData[0].center_id : '';
                    setSelectedCenterId(autoCenter);

                    // Set default batch based on auto-selected center
                    const filteredBatches = autoCenter
                        ? (batchesRes.data || []).filter(b => b.center_id === autoCenter)
                        : batchesRes.data || [];
                    if (filteredBatches.length > 0) {
                        setStudentForm(prev => ({ ...prev, batch_id: filteredBatches[0].batch_id }));
                    }
                } catch (err) {
                    setError('Failed to load data: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleEnroll = async (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');
                setSaving(true);

                try {
                    // Validate student fields
                    const cleanStudentName = validateName(studentForm.student_name, 'Student name');
                    const cleanNotes = studentForm.notes ? validateSafeInput(studentForm.notes, 'Notes') : '';
                    if (!studentForm.date_of_birth) throw new Error('Date of birth is required.');

                    let parentId = null;

                    if (parentMode === 'existing') {
                        if (!selectedParentId) throw new Error('Please select an existing parent.');
                        parentId = selectedParentId;
                    } else {
                        // Validate parent fields
                        const cleanParentName = validateName(parentForm.parent_name, 'Parent name');
                        if (!parentForm.email?.trim()) throw new Error('Parent email is required.');
                        if (!parentForm.phone?.trim()) throw new Error('Parent phone is required.');
                        const cleanEmail = validateEmail(parentForm.email);
                        const cleanPhone = validatePhone(parentForm.phone);

                        // Insert new parent
                        const { data: newParent, error: parentError } = await supabase
                            .from('parents')
                            .insert({
                                parent_name: cleanParentName,
                                email: cleanEmail || null,
                                phone: cleanPhone || null,
                                relationship_type: parentForm.relationship_type,
                                preferred_contact: parentForm.preferred_contact
                            })
                            .select()
                            .single();

                        if (parentError) throw parentError;
                        parentId = newParent.parent_id;
                    }

                    // Insert student
                    const { data: newStudent, error: studentError } = await supabase
                        .from('students')
                        .insert({
                            student_name: cleanStudentName,
                            date_of_birth: studentForm.date_of_birth,
                            parent_id: parentId,
                            batch_id: studentForm.batch_id,
                            notes: cleanNotes || null
                        })
                        .select('*, parents(parent_name, email, phone), batches(batch_name, batch_code)')
                        .single();

                    if (studentError) throw studentError;

                    setStudents([...students, newStudent]);
                    setSuccess('Student enrolled successfully!');
                    resetForm();
                    setShowEnrollForm(false);
                    // Reload parents list in case a new one was added
                    const { data: freshParents } = await supabase.from('parents').select('*').order('parent_name');
                    setParents(freshParents || []);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setSaving(false);
                }
            };

            const resetForm = () => {
                setParentForm({ parent_name: '', email: '', phone: '', relationship_type: 'parent', preferred_contact: 'email' });
                const defaultCenter = centers.length === 1 ? centers[0].center_id : '';
                setSelectedCenterId(defaultCenter);
                const filtered = defaultCenter ? batches.filter(b => b.center_id === defaultCenter) : batches;
                setStudentForm({ student_name: '', date_of_birth: '', batch_id: filtered[0]?.batch_id || '', notes: '' });
                setParentMode('new');
                setSelectedParentId('');
            };

            const startEdit = (student) => {
                setEditingStudent(student.student_id);
                setEditForm({
                    student_name: student.student_name,
                    date_of_birth: student.date_of_birth || '',
                    batch_id: student.batch_id,
                    center_student_id: student.center_student_id || '',
                    notes: student.notes || '',
                    is_active: student.is_active
                });
            };

            const handleUpdate = async (studentId) => {
                setError('');
                setSuccess('');
                try {
                    const cleanName = validateName(editForm.student_name, 'Student name');
                    const cleanNotes = editForm.notes ? validateSafeInput(editForm.notes, 'Notes') : '';
                    const cleanCenterStudentId = editForm.center_student_id ? validateSafeInput(editForm.center_student_id, 'Center Student ID') : '';

                    const { error } = await supabase
                        .from('students')
                        .update({
                            student_name: cleanName,
                            date_of_birth: editForm.date_of_birth || null,
                            batch_id: editForm.batch_id,
                            center_student_id: cleanCenterStudentId || null,
                            notes: cleanNotes || null,
                            is_active: editForm.is_active
                        })
                        .eq('student_id', studentId);

                    if (error) throw error;

                    setEditingStudent(null);
                    setSuccess('Student updated successfully!');
                    loadData();
                } catch (err) {
                    setError(err.message);
                }
            };

            const deleteStudent = async (studentId, studentName) => {
                if (!confirm(`Are you sure you want to delete "${studentName}"? This cannot be undone.`)) return;
                try {
                    // Find the parent_id before deleting
                    const student = students.find(s => s.student_id === studentId);
                    const parentId = student?.parent_id;

                    const { error } = await supabase
                        .from('students')
                        .delete()
                        .eq('student_id', studentId);

                    if (error) throw error;
                    const remainingStudents = students.filter(s => s.student_id !== studentId);
                    setStudents(remainingStudents);

                    // Delete orphaned parent (no remaining students)
                    if (parentId) {
                        const { count } = await supabase
                            .from('students')
                            .select('student_id', { count: 'exact', head: true })
                            .eq('parent_id', parentId);
                        if (count === 0) {
                            await supabase.from('parents').delete().eq('parent_id', parentId);
                            setParents(parents.filter(p => p.parent_id !== parentId));
                        }
                    }

                    setSuccess('Student deleted successfully!');
                } catch (err) {
                    setError('Failed to delete: ' + err.message);
                }
            };

            if (loading) {
                return (
                    <div className="text-center py-12">
                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-600 border-t-transparent"></div>
                        <p className="mt-2 text-gray-600">Loading students...</p>
                    </div>
                );
            }

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">Students & Parents</h2>
                            <p className="text-gray-600">{students.length} students, {parents.length} parents</p>
                        </div>
                        <button
                            onClick={() => { resetForm(); setShowEnrollForm(true); }}
                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                        >
                            + Enroll Student
                        </button>
                    </div>

                    {error && (
                        <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-4">
                            {error}
                            <button onClick={() => setError('')} className="float-right font-bold">x</button>
                        </div>
                    )}
                    {success && (
                        <div className="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg mb-4">
                            {success}
                            <button onClick={() => setSuccess('')} className="float-right font-bold">x</button>
                        </div>
                    )}

                    {/* Enrollment Form */}
                    {showEnrollForm && (
                        <div className="bg-white rounded-lg shadow p-6 mb-6">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4">Enroll New Student</h3>
                            <form onSubmit={handleEnroll}>
                                {/* Parent Section */}
                                <div className="mb-6">
                                    <div className="flex items-center gap-4 mb-3">
                                        <h4 className="font-medium text-gray-700">Parent / Guardian</h4>
                                        <div className="flex gap-2">
                                            <button type="button" onClick={() => setParentMode('new')}
                                                className={`px-3 py-1 text-sm rounded ${parentMode === 'new' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}>
                                                New Parent
                                            </button>
                                            <button type="button" onClick={() => setParentMode('existing')}
                                                className={`px-3 py-1 text-sm rounded ${parentMode === 'existing' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}>
                                                Existing Parent
                                            </button>
                                        </div>
                                    </div>

                                    {parentMode === 'existing' ? (
                                        <select value={selectedParentId}
                                            onChange={(e) => setSelectedParentId(e.target.value)}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                            <option value="">-- Select Parent --</option>
                                            {parents.map(p => (
                                                <option key={p.parent_id} value={p.parent_id}>
                                                    {p.parent_name} {p.email ? `(${p.email})` : ''} {p.phone ? `[${p.phone}]` : ''}
                                                </option>
                                            ))}
                                        </select>
                                    ) : (
                                        <div className="grid gap-4 md:grid-cols-2">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Parent Name *</label>
                                                <input type="text" value={parentForm.parent_name}
                                                    onChange={(e) => setParentForm({ ...parentForm, parent_name: e.target.value })}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    placeholder="e.g., Priya Sharma" required maxLength={100} />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                                <input type="email" value={parentForm.email}
                                                    onChange={(e) => setParentForm({ ...parentForm, email: e.target.value })}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    placeholder="parent@example.com" required maxLength={100} />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                                                <input type="tel" value={parentForm.phone}
                                                    onChange={(e) => setParentForm({ ...parentForm, phone: e.target.value })}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    placeholder="+91 99999 99999" required maxLength={20} />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Relationship</label>
                                                <select value={parentForm.relationship_type}
                                                    onChange={(e) => setParentForm({ ...parentForm, relationship_type: e.target.value })}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                    <option value="parent">Parent</option>
                                                    <option value="guardian">Guardian</option>
                                                    <option value="grandparent">Grandparent</option>
                                                    <option value="other">Other</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Preferred Contact</label>
                                                <select value={parentForm.preferred_contact}
                                                    onChange={(e) => setParentForm({ ...parentForm, preferred_contact: e.target.value })}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                    <option value="email">Email</option>
                                                    <option value="phone">Phone</option>
                                                    <option value="whatsapp">WhatsApp</option>
                                                </select>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Student Section */}
                                <div className="border-t pt-4">
                                    <h4 className="font-medium text-gray-700 mb-3">Student Details</h4>
                                    <div className="grid gap-4 md:grid-cols-2">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Student Name *</label>
                                            <input type="text" value={studentForm.student_name}
                                                onChange={(e) => setStudentForm({ ...studentForm, student_name: e.target.value })}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                placeholder="e.g., Aarav Sharma" required maxLength={100} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Date of Birth *</label>
                                            <input type="date" value={studentForm.date_of_birth}
                                                onChange={(e) => setStudentForm({ ...studentForm, date_of_birth: e.target.value })}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Center *</label>
                                            <select value={selectedCenterId}
                                                onChange={(e) => {
                                                    const cid = e.target.value;
                                                    setSelectedCenterId(cid);
                                                    const filtered = cid ? batches.filter(b => b.center_id === cid) : batches;
                                                    setStudentForm(prev => ({ ...prev, batch_id: filtered[0]?.batch_id || '' }));
                                                }}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                                {centers.length !== 1 && <option value="">-- Select Center --</option>}
                                                {centers.map(c => (
                                                    <option key={c.center_id} value={c.center_id}>{c.center_name}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Batch *</label>
                                            <select value={studentForm.batch_id}
                                                onChange={(e) => setStudentForm({ ...studentForm, batch_id: e.target.value })}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                                {!selectedCenterId && <option value="">-- Select a center first --</option>}
                                                {(selectedCenterId ? batches.filter(b => b.center_id === selectedCenterId) : batches).map(c => (
                                                    <option key={c.batch_id} value={c.batch_id}>
                                                        {c.batch_name} {c.batch_code ? `[${c.batch_code}]` : ''}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="md:col-span-2">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                            <textarea value={studentForm.notes}
                                                onChange={(e) => setStudentForm({ ...studentForm, notes: e.target.value })}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                placeholder="Any special notes..." rows={2} maxLength={500} />
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-4 flex gap-3">
                                    <button type="submit" disabled={saving}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition">
                                        {saving ? 'Enrolling...' : 'Enroll Student'}
                                    </button>
                                    <button type="button" onClick={() => setShowEnrollForm(false)}
                                        className="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-100 transition">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    {/* Students Table */}
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <table className="w-full">
                            <thead className="bg-gray-100">
                                <tr>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Student</th>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Parent</th>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Batch</th>
                                    <th className="px-4 py-3 text-center text-sm font-semibold text-gray-700">Status</th>
                                    <th className="px-4 py-3 text-center text-sm font-semibold text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                                {students.map(student => (
                                    <tr key={student.student_id} className="hover:bg-gray-50">
                                        {editingStudent === student.student_id ? (
                                            <>
                                                <td className="px-4 py-3">
                                                    <input type="text" value={editForm.student_name}
                                                        onChange={(e) => setEditForm({ ...editForm, student_name: e.target.value })}
                                                        className="w-full px-2 py-1 border border-gray-300 rounded text-sm" maxLength={100} />
                                                </td>
                                                <td className="px-4 py-3 text-gray-600 text-sm">
                                                    {student.parents?.parent_name || '-'}
                                                </td>
                                                <td className="px-4 py-3">
                                                    <select value={editForm.batch_id}
                                                        onChange={(e) => setEditForm({ ...editForm, batch_id: e.target.value })}
                                                        className="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                                        {batches.map(c => (
                                                            <option key={c.batch_id} value={c.batch_id}>{c.batch_name}</option>
                                                        ))}
                                                    </select>
                                                </td>
                                                <td className="px-4 py-3 text-center">
                                                    <select value={editForm.is_active ? 'active' : 'inactive'}
                                                        onChange={(e) => setEditForm({ ...editForm, is_active: e.target.value === 'active' })}
                                                        className="px-2 py-1 text-sm border rounded">
                                                        <option value="active">Active</option>
                                                        <option value="inactive">Inactive</option>
                                                    </select>
                                                </td>
                                                <td className="px-4 py-3 text-center">
                                                    <button onClick={() => handleUpdate(student.student_id)}
                                                        className="text-green-600 hover:text-green-800 text-sm mr-2">Save</button>
                                                    <button onClick={() => setEditingStudent(null)}
                                                        className="text-gray-600 hover:text-gray-800 text-sm">Cancel</button>
                                                </td>
                                            </>
                                        ) : (
                                            <>
                                                <td className="px-4 py-3">
                                                    <div className="font-medium text-gray-800">{student.student_name}</div>
                                                    {student.date_of_birth && <div className="text-xs text-gray-500">DOB: {student.date_of_birth}</div>}
                                                    {student.center_student_id && <div className="text-xs text-gray-500">ID: {student.center_student_id}</div>}
                                                </td>
                                                <td className="px-4 py-3 text-sm text-gray-600">
                                                    <div>{student.parents?.parent_name || '-'}</div>
                                                    {student.parents?.email && <div className="text-xs text-gray-500">{student.parents.email}</div>}
                                                    {student.parents?.phone && <div className="text-xs text-gray-500">{student.parents.phone}</div>}
                                                </td>
                                                <td className="px-4 py-3 text-sm text-gray-600">
                                                    {student.batches?.batch_name || '-'}
                                                    {student.batches?.batch_code && <span className="text-xs text-gray-400 ml-1">[{student.batches.batch_code}]</span>}
                                                </td>
                                                <td className="px-4 py-3 text-center">
                                                    <span className={`px-2 py-1 text-xs rounded ${student.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}`}>
                                                        {student.is_active ? 'Active' : 'Inactive'}
                                                    </span>
                                                </td>
                                                <td className="px-4 py-3 text-center">
                                                    <button onClick={() => startEdit(student)}
                                                        className="text-blue-600 hover:text-blue-800 text-sm mr-2">Edit</button>
                                                    <button onClick={() => deleteStudent(student.student_id, student.student_name)}
                                                        className="text-red-600 hover:text-red-800 text-sm">Delete</button>
                                                </td>
                                            </>
                                        )}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {students.length === 0 && (
                            <div className="text-center py-8 text-gray-500">
                                No students yet. Enroll your first student above.
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // =====================================================
        // GRADESHEET CREATOR COMPONENT
        // =====================================================
        function GradesheetCreator() {
            const [batches, setBatches] = useState([]);
            const [selectedBatch, setSelectedBatch] = useState('');
            const [selectedBatchData, setSelectedBatchData] = useState(null);
            const [classNumber, setClassNumber] = useState('');
            const [level, setLevel] = useState('');
            const [students, setStudents] = useState([]);
            const [activities, setActivities] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [sheetGenerated, setSheetGenerated] = useState(false);

            // Editable fields for the header
            const [version, setVersion] = useState('V1');
            const [editableLevel, setEditableLevel] = useState('');
            const [editableClass, setEditableClass] = useState('');
            const [editableBatch, setEditableBatch] = useState('');

            // Load batches on mount
            useEffect(() => {
                loadBatches();
            }, []);

            const loadBatches = async () => {
                try {
                    const { data, error } = await supabase
                        .from('batches')
                        .select(`
                            batch_id,
                            batch_name,
                            batch_code,
                            level,
                            centers (center_name),
                            is_active
                        `)
                        .eq('is_active', true)
                        .order('batch_name');

                    if (error) throw error;
                    setBatches(data || []);
                } catch (err) {
                    setError('Failed to load batches: ' + err.message);
                }
            };

            const handleBatchChange = async (batchId) => {
                setSelectedBatch(batchId);
                setSheetGenerated(false);
                setError('');

                if (!batchId) {
                    setSelectedBatchData(null);
                    setStudents([]);
                    setActivities([]);
                    return;
                }

                const batch = batches.find(b => b.batch_id === batchId);
                setSelectedBatchData(batch);
                setLevel(batch?.level || '');
                setEditableLevel(batch?.level || '');
                setEditableBatch(batch?.batch_code || '');
            };

            const generateGradesheet = async () => {
                if (!selectedBatch || !classNumber) {
                    setError('Please select a batch and enter a class number');
                    return;
                }

                setLoading(true);
                setError('');

                try {
                    // Fetch students for the selected batch
                    const { data: studentsData, error: studentsError } = await supabase
                        .from('students')
                        .select('student_id, student_name, center_student_id')
                        .eq('batch_id', selectedBatch)
                        .eq('is_active', true)
                        .order('student_name');

                    if (studentsError) throw studentsError;

                    // Fetch activities for the selected level and class number
                    const { data: activitiesData, error: activitiesError } = await supabase
                        .from('activities')
                        .select(`
                            activity_id,
                            activity_name,
                            sequence_in_class,
                            learning_areas (learning_area_name)
                        `)
                        .eq('level', level)
                        .eq('class_number', classNumber)
                        .not('sequence_in_class', 'is', null)
                        .order('sequence_in_class');

                    if (activitiesError) throw activitiesError;

                    if (!activitiesData || activitiesData.length === 0) {
                        setError('No activities found for Level ' + level + ', Class ' + classNumber);
                        setLoading(false);
                        return;
                    }

                    if (activitiesData.length > 10) {
                        setError('Maximum 10 activities supported. Found ' + activitiesData.length);
                        setLoading(false);
                        return;
                    }

                    setStudents(studentsData || []);
                    setActivities(activitiesData || []);
                    setEditableClass(classNumber);
                    setSheetGenerated(true);
                } catch (err) {
                    setError('Failed to generate gradesheet: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handlePrint = () => {
                window.print();
            };

            const handleStudentNameEdit = (studentId, newName) => {
                setStudents(students.map(s =>
                    s.student_id === studentId ? { ...s, student_name: newName } : s
                ));
            };

            const handleActivityNameEdit = (activityId, newName) => {
                setActivities(activities.map(a =>
                    a.activity_id === activityId ? { ...a, activity_name: newName } : a
                ));
            };

            // Split activities into two tables
            const splitActivities = () => {
                const half = Math.ceil(activities.length / 2);
                return {
                    topActivities: activities.slice(0, half),
                    bottomActivities: activities.slice(half)
                };
            };

            const { topActivities, bottomActivities } = sheetGenerated ? splitActivities() : { topActivities: [], bottomActivities: [] };

            return (
                <div>
                    {/* Controls - Hidden when printing */}
                    <div className="no-print mb-6 bg-white p-6 rounded-lg shadow">
                        <h2 className="text-2xl font-bold mb-4">Generate Gradesheet</h2>

                        {error && (
                            <div className="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
                                {error}
                            </div>
                        )}

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Select Batch
                                </label>
                                <select
                                    value={selectedBatch}
                                    onChange={(e) => handleBatchChange(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                >
                                    <option value="">-- Select Batch --</option>
                                    {batches.map((batch) => (
                                        <option key={batch.batch_id} value={batch.batch_id}>
                                            {batch.batch_name} ({batch.centers?.center_name}) - Level {batch.level}
                                        </option>
                                    ))}
                                </select>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Class Number (1-36)
                                </label>
                                <input
                                    type="number"
                                    min="1"
                                    max="36"
                                    value={classNumber}
                                    onChange={(e) => setClassNumber(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                    placeholder="Enter class number"
                                />
                            </div>

                            <div className="flex items-end">
                                <button
                                    onClick={generateGradesheet}
                                    disabled={loading || !selectedBatch || !classNumber}
                                    className="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                                >
                                    {loading ? 'Generating...' : 'Generate Gradesheet'}
                                </button>
                            </div>
                        </div>

                        {sheetGenerated && (
                            <div className="mt-4">
                                <button
                                    onClick={handlePrint}
                                    className="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
                                >
                                    Print Gradesheet
                                </button>
                                <p className="text-sm text-gray-600 mt-2">
                                    Generated {students.length} students with {activities.length} activities
                                </p>
                            </div>
                        )}
                    </div>

                    {/* Printable Gradesheet */}
                    {sheetGenerated && (
                        <div className="print-sheet bg-white p-8">
                            {/* Header Row */}
                            <div className="header-row mb-4" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr 1fr', gap: '0', border: '2px solid black' }}>
                                <div style={{ border: '1px solid black', padding: '4px', textAlign: 'center', fontWeight: 'bold' }}>
                                    <input
                                        type="text"
                                        value={version}
                                        onChange={(e) => setVersion(e.target.value)}
                                        className="no-print-border w-full text-center font-bold"
                                        style={{ border: 'none', background: 'transparent' }}
                                    />
                                </div>
                                <div style={{ border: '1px solid black', padding: '4px', textAlign: 'center', fontWeight: 'bold' }}>
                                    Level: <input
                                        type="text"
                                        value={editableLevel}
                                        onChange={(e) => setEditableLevel(e.target.value)}
                                        className="no-print-border"
                                        style={{ border: 'none', background: 'transparent', width: '30px', textAlign: 'center', fontWeight: 'bold' }}
                                    />
                                </div>
                                <div style={{ border: '1px solid black', padding: '4px', textAlign: 'center', fontWeight: 'bold' }}>
                                    Class: <input
                                        type="text"
                                        value={editableClass}
                                        onChange={(e) => setEditableClass(e.target.value)}
                                        className="no-print-border"
                                        style={{ border: 'none', background: 'transparent', width: '40px', textAlign: 'center', fontWeight: 'bold' }}
                                    />
                                </div>
                                <div style={{ border: '1px solid black', padding: '4px', textAlign: 'center', fontWeight: 'bold' }}>
                                    Batch Code: <input
                                        type="text"
                                        value={editableBatch}
                                        onChange={(e) => setEditableBatch(e.target.value)}
                                        className="no-print-border"
                                        style={{ border: 'none', background: 'transparent', width: '40px', textAlign: 'center', fontWeight: 'bold' }}
                                    />
                                </div>
                                <div style={{ border: '1px solid black', padding: '4px', textAlign: 'center', fontWeight: 'bold' }}>
                                </div>
                            </div>

                            <h3 className="text-xl font-bold text-center mb-4">Class Topsheet</h3>

                            {/* Top Table */}
                            <table className="gradesheet-table mb-6">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Student Name</th>
                                        {topActivities.map((activity, idx) => (
                                            <th key={activity.activity_id}>
                                                <input
                                                    type="text"
                                                    value={activity.activity_name}
                                                    onChange={(e) => handleActivityNameEdit(activity.activity_id, e.target.value)}
                                                    className="no-print-border w-full text-center"
                                                    style={{ border: 'none', background: 'transparent', minWidth: '60px' }}
                                                />
                                            </th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {students.map((student) => (
                                        <tr key={student.student_id}>
                                            <td className="text-center">{student.center_student_id}</td>
                                            <td>
                                                <input
                                                    type="text"
                                                    value={student.student_name}
                                                    onChange={(e) => handleStudentNameEdit(student.student_id, e.target.value)}
                                                    className="no-print-border w-full"
                                                    style={{ border: 'none', background: 'transparent' }}
                                                />
                                            </td>
                                            {topActivities.map((activity) => (
                                                <td key={activity.activity_id}></td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>

                            {/* Bottom Table - Only if there are activities in the bottom half */}
                            {bottomActivities.length > 0 && (
                                <table className="gradesheet-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Student Name</th>
                                            {bottomActivities.map((activity) => (
                                                <th key={activity.activity_id}>
                                                    <input
                                                        type="text"
                                                        value={activity.activity_name}
                                                        onChange={(e) => handleActivityNameEdit(activity.activity_id, e.target.value)}
                                                        className="no-print-border w-full text-center"
                                                        style={{ border: 'none', background: 'transparent', minWidth: '60px' }}
                                                    />
                                                </th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {students.map((student) => (
                                            <tr key={student.student_id}>
                                                <td className="text-center">{student.center_student_id}</td>
                                                <td>
                                                    <input
                                                        type="text"
                                                        value={student.student_name}
                                                        onChange={(e) => handleStudentNameEdit(student.student_id, e.target.value)}
                                                        className="no-print-border w-full"
                                                        style={{ border: 'none', background: 'transparent' }}
                                                    />
                                                </td>
                                                {bottomActivities.map((activity) => (
                                                    <td key={activity.activity_id}></td>
                                                ))}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    )}

                    {/* Print Styles */}
                    <style>{`
                        @media print {
                            body * {
                                visibility: hidden;
                            }
                            .print-sheet, .print-sheet * {
                                visibility: visible;
                            }
                            .print-sheet {
                                position: absolute;
                                left: 0;
                                top: 0;
                                width: 100%;
                            }
                            .no-print {
                                display: none !important;
                            }
                            .gradesheet-table {
                                border-collapse: collapse;
                                width: 100%;
                                font-size: 10pt;
                                page-break-inside: avoid;
                            }
                            .gradesheet-table th,
                            .gradesheet-table td {
                                border: 1px solid black;
                                padding: 6px;
                            }
                            .gradesheet-table th {
                                background-color: white;
                                font-weight: bold;
                                text-align: center;
                            }
                            input {
                                border: none !important;
                                outline: none !important;
                            }
                            @page {
                                size: A4;
                                margin: 1cm;
                            }
                        }

                        .gradesheet-table {
                            border-collapse: collapse;
                            width: 100%;
                            margin-bottom: 1rem;
                        }

                        .gradesheet-table th,
                        .gradesheet-table td {
                            border: 1px solid black;
                            padding: 8px;
                            text-align: left;
                        }

                        .gradesheet-table th {
                            background-color: #f3f4f6;
                            font-weight: bold;
                            text-align: center;
                        }

                        .gradesheet-table td {
                            min-height: 30px;
                        }

                        .no-print-border:focus {
                            outline: 1px solid #3b82f6;
                        }
                    `}</style>
                </div>
            );
        }

        // =====================================================
        // ADMIN DASHBOARD COMPONENT
        // =====================================================
        function AdminDashboard({ user, teacher, onSignOut }) {
            const [activeTab, setActiveTab] = useState('students');

            return (
                <div className="min-h-screen bg-gray-100">
                    <AdminHeader user={user} onSignOut={onSignOut} />

                    <div className="max-w-7xl mx-auto px-4 py-6">
                        {/* Tab Navigation */}
                        <div className="flex gap-2 mb-6 border-b border-gray-300">
                            <button
                                onClick={() => setActiveTab('students')}
                                className={`px-4 py-2 font-medium transition ${
                                    activeTab === 'students'
                                        ? 'text-blue-600 border-b-2 border-blue-600'
                                        : 'text-gray-600 hover:text-gray-800'
                                }`}
                            >
                                Students
                            </button>
                            <button
                                onClick={() => setActiveTab('activities')}
                                className={`px-4 py-2 font-medium transition ${
                                    activeTab === 'activities'
                                        ? 'text-blue-600 border-b-2 border-blue-600'
                                        : 'text-gray-600 hover:text-gray-800'
                                }`}
                            >
                                Activities
                            </button>
                            <button
                                onClick={() => setActiveTab('centers')}
                                className={`px-4 py-2 font-medium transition ${
                                    activeTab === 'centers'
                                        ? 'text-blue-600 border-b-2 border-blue-600'
                                        : 'text-gray-600 hover:text-gray-800'
                                }`}
                            >
                                Centers
                            </button>
                            <button
                                onClick={() => setActiveTab('teachers')}
                                className={`px-4 py-2 font-medium transition ${
                                    activeTab === 'teachers'
                                        ? 'text-blue-600 border-b-2 border-blue-600'
                                        : 'text-gray-600 hover:text-gray-800'
                                }`}
                            >
                                Teachers
                            </button>
                            <button
                                onClick={() => setActiveTab('gradesheets')}
                                className={`px-4 py-2 font-medium transition ${
                                    activeTab === 'gradesheets'
                                        ? 'text-blue-600 border-b-2 border-blue-600'
                                        : 'text-gray-600 hover:text-gray-800'
                                }`}
                            >
                                Gradesheets
                            </button>
                        </div>

                        {/* Tab Content */}
                        {activeTab === 'students' && <StudentManagement user={user} teacher={teacher} />}
                        {activeTab === 'activities' && <ActivityManagement />}
                        {activeTab === 'centers' && <CenterManagement />}
                        {activeTab === 'teachers' && <TeacherManagement />}
                        {activeTab === 'gradesheets' && <GradesheetCreator />}
                    </div>
                </div>
            );
        }

        // =====================================================
        // MAIN APP COMPONENT
        // =====================================================
        function App() {
            const [user, setUser] = useState(null);
            const [teacher, setTeacher] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                checkAuth();
            }, []);

            const checkAuth = async () => {
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    
                    if (session?.user) {
                        setUser(session.user);
                        
                        // Check if user is admin
                        const { data: teacherData, error } = await supabase
                            .from('teachers')
                            .select('*')
                            .eq('teacher_id', session.user.id)
                            .single();

                        if (!error && teacherData) {
                            setTeacher(teacherData);
                        }
                    }
                } catch (err) {
                    console.error('Auth check error:', err);
                } finally {
                    setLoading(false);
                }
            };

            const handleSignOut = async () => {
                await supabase.auth.signOut();
                window.location.href = '/';
            };

            // Loading
            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent"></div>
                            <p className="mt-4 text-gray-600">Loading...</p>
                        </div>
                    </div>
                );
            }

            // Not logged in
            if (!user) {
                return <LoginPrompt />;
            }

            // Not admin
            if (!teacher || (teacher.role !== 'admin' && teacher.role !== 'site_admin')) {
                return <AccessDenied />;
            }

            // Admin dashboard
            return <AdminDashboard user={user} teacher={teacher} onSignOut={handleSignOut} />;
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
