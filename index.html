<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gradesheet Scanner - Enrichment Express</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind config with brand colors
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            red: '#E63946',      // Primary red
                            teal: '#2A9D8F',     // Primary teal
                            'teal-dark': '#1E7268',
                            'red-dark': '#C1121F',
                            cream: '#FFF8F0',    // Light background
                            white: '#FFFFFF',
                        }
                    }
                }
            }
        }
    </script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // =====================================================
        // CONFIGURATION
        // =====================================================
        const SUPABASE_URL = 'https://zfkdypxmegocmjontbiz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpma2R5cHhtZWdvY21qb250Yml6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NzM3MDMsImV4cCI6MjA4MTU0OTcwM30.GLwItBWPKW4EZ67wiAPuaKq38DA5WfJ5UYcvPPYsWwI';
        
        // =====================================================
        // LOGO CONFIGURATION
        // =====================================================
        // >>> REPLACE THIS URL WITH YOUR COMPANY LOGO <<<
        // Upload your logo to Supabase Storage or use any public URL
        const COMPANY_LOGO_URL = '/logo.png';  // Place logo.png in your repo root, or use full URL like 'https://enrichmentexpress.com/assets/image/logo/1.png'
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // API endpoint (Supabase Edge Function - 150s timeout)
        const API_ENDPOINT = `${SUPABASE_URL}/functions/v1/openai`;

        // =====================================================
        // DEBUG MODE (for site_admin role)
        // =====================================================
        let DEBUG_MODE = false;
        let DEBUG_LOGS = [];
        
        function debugLog(label, data) {
            if (DEBUG_MODE) {
                const entry = { time: new Date().toISOString(), label, data };
                DEBUG_LOGS.push(entry);
                console.log(`[DEBUG] ${label}:`, data);
            }
        }

        // =====================================================
        // API HELPER - Calls Supabase Edge Function
        // =====================================================
        async function callOpenAI(action, data) {
            const session = await supabase.auth.getSession();
            const token = session?.data?.session?.access_token;

            if (!token) {
                throw new Error('Not authenticated');
            }

            debugLog('API Request', { action, dataKeys: Object.keys(data || {}) });

            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    'apikey': SUPABASE_ANON_KEY,
                },
                body: JSON.stringify({ action, data }),
            });

            const result = await response.json();
            
            debugLog('API Response', { status: response.status, result });

            if (!response.ok) {
                throw new Error(result.error || 'API request failed');
            }

            return result;
        }

        // =====================================================
        // AUTHENTICATION COMPONENT
        // =====================================================
        function AuthScreen({ onAuthSuccess }) {
            const [isLogin, setIsLogin] = useState(true);
            const [showForgotPassword, setShowForgotPassword] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setMessage('');
                setLoading(true);

                try {
                    if (isLogin) {
                        const { data, error } = await supabase.auth.signInWithPassword({
                            email,
                            password
                        });
                        if (error) throw error;
                        onAuthSuccess(data.user);
                    } else {
                        const { data, error } = await supabase.auth.signUp({
                            email,
                            password,
                            options: {
                                data: { name }
                            }
                        });
                        if (error) throw error;
                        
                        // Check if user already exists (Supabase returns a user with identities = [] for existing users)
                        if (data.user && data.user.identities && data.user.identities.length === 0) {
                            throw new Error('An account with this email already exists. Please sign in instead.');
                        }
                        
                        if (data.user && !data.session) {
                            setMessage('Check your email for the confirmation link!');
                        } else {
                            onAuthSuccess(data.user);
                        }
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleForgotPassword = async (e) => {
                e.preventDefault();
                setError('');
                setMessage('');
                
                if (!email.trim()) {
                    setError('Please enter your email address');
                    return;
                }
                
                setLoading(true);

                try {
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin,
                    });
                    if (error) throw error;
                    setMessage('Password reset link sent! Check your email.');
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-brand-cream to-white flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full border-t-4 border-brand-teal">
                        {/* LOGO - Replace COMPANY_LOGO_URL at top of file */}
                        <div className="flex justify-center mb-6">
                            <img src={COMPANY_LOGO_URL} alt="Company Logo" className="h-16 object-contain" onError={(e) => e.target.style.display='none'} />
                        </div>
                        <h1 className="text-3xl font-bold text-brand-teal mb-2 text-center">Gradesheet Scanner</h1>
                        <p className="text-gray-600 mb-6 text-center">
                            {showForgotPassword ? 'Reset your password' : (isLogin ? 'Sign in to continue' : 'Create your account')}
                        </p>

                        {error && (
                            <div className="bg-red-50 border border-brand-red text-brand-red px-4 py-3 rounded-lg mb-4">
                                {error}
                            </div>
                        )}

                        {message && (
                            <div className="bg-teal-50 border border-brand-teal text-brand-teal-dark px-4 py-3 rounded-lg mb-4">
                                {message}
                            </div>
                        )}

                        {showForgotPassword ? (
                            /* Forgot Password Form */
                            <form onSubmit={handleForgotPassword}>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Email Address
                                    </label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        placeholder="you@example.com"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent"
                                        required
                                    />
                                </div>

                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full bg-brand-teal text-white py-3 rounded-lg font-medium hover:bg-brand-teal-dark disabled:bg-gray-400 disabled:cursor-not-allowed transition"
                                >
                                    {loading ? 'Please wait...' : 'Send Reset Link'}
                                </button>

                                <div className="mt-4 text-center">
                                    <button
                                        type="button"
                                        onClick={() => {
                                            setShowForgotPassword(false);
                                            setError('');
                                            setMessage('');
                                        }}
                                        className="text-brand-teal hover:underline"
                                    >
                                        Back to Sign In
                                    </button>
                                </div>
                            </form>
                        ) : (
                            /* Login / Signup Form */
                            <form onSubmit={handleSubmit}>
                                {!isLogin && (
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Your Name
                                        </label>
                                        <input
                                            type="text"
                                            value={name}
                                            onChange={(e) => setName(e.target.value)}
                                            placeholder="Jane Smith"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent"
                                            required={!isLogin}
                                        />
                                    </div>
                                )}

                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Email Address
                                    </label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        placeholder="you@example.com"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent"
                                        required
                                    />
                                </div>

                                <div className="mb-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Password
                                    </label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        placeholder="••••••••"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent"
                                        required
                                        minLength={6}
                                    />
                                </div>

                                {isLogin && (
                                    <div className="mb-6 text-right">
                                        <button
                                            type="button"
                                            onClick={() => {
                                                setShowForgotPassword(true);
                                                setError('');
                                                setMessage('');
                                            }}
                                            className="text-sm text-brand-teal hover:underline"
                                        >
                                            Forgot password?
                                        </button>
                                    </div>
                                )}

                                {!isLogin && <div className="mb-6"></div>}

                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full bg-brand-teal text-white py-3 rounded-lg font-medium hover:bg-brand-teal-dark disabled:bg-gray-400 disabled:cursor-not-allowed transition"
                                >
                                    {loading ? 'Please wait...' : (isLogin ? 'Sign In' : 'Create Account')}
                                </button>
                            </form>
                        )}

                        {!showForgotPassword && (
                            <div className="mt-6 text-center">
                                <button
                                    onClick={() => {
                                        setIsLogin(!isLogin);
                                        setError('');
                                        setMessage('');
                                    }}
                                    className="text-brand-teal hover:underline"
                                >
                                    {isLogin ? "Don't have an account? Sign up" : 'Already have an account? Sign in'}
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // =====================================================
        // NAVIGATION HEADER COMPONENT
        // =====================================================
        function NavHeader({ user, onSignOut, currentView, onViewChange, isSiteAdmin }) {
            const [showMenu, setShowMenu] = useState(false);

            return (
                <header className="bg-white shadow-sm border-b-2 border-brand-teal">
                    <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                        <div className="flex items-center gap-6">
                            {/* LOGO IN HEADER */}
                            <div className="flex items-center gap-3">
                                <img src={COMPANY_LOGO_URL} alt="Logo" className="h-10 object-contain" onError={(e) => e.target.style.display='none'} />
                                <h1 className="text-xl font-bold text-brand-teal">Gradesheet Scanner</h1>
                            </div>
                            <nav className="hidden md:flex gap-4">
                                <button
                                    onClick={() => onViewChange('scanner')}
                                    className={`px-3 py-1 rounded ${currentView === 'scanner' ? 'bg-teal-100 text-brand-teal' : 'text-gray-600 hover:text-gray-800'}`}
                                >
                                    Scanner
                                </button>
                                <button
                                    onClick={() => onViewChange('history')}
                                    className={`px-3 py-1 rounded ${currentView === 'history' ? 'bg-teal-100 text-brand-teal' : 'text-gray-600 hover:text-gray-800'}`}
                                >
                                    History
                                </button>
                                <button
                                    onClick={() => onViewChange('batches')}
                                    className={`px-3 py-1 rounded ${currentView === 'batches' ? 'bg-teal-100 text-brand-teal' : 'text-gray-600 hover:text-gray-800'}`}
                                >
                                    Batches
                                </button>
                                {isSiteAdmin && (
                                    <a
                                        href="/admin.html"
                                        className="px-3 py-1 rounded text-purple-600 hover:bg-purple-50 font-medium"
                                    >
                                        Admin
                                    </a>
                                )}
                            </nav>
                        </div>
                        
                        <div className="relative">
                            <button
                                onClick={() => setShowMenu(!showMenu)}
                                className="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100"
                            >
                                <div className="w-8 h-8 bg-brand-teal rounded-full flex items-center justify-center text-white font-medium">
                                    {user?.email?.[0]?.toUpperCase() || '?'}
                                </div>
                                <span className="hidden sm:inline text-gray-700">{user?.email}</span>
                            </button>

                            {showMenu && (
                                <div className="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50">
                                    <div className="md:hidden border-b border-gray-200 pb-1 mb-1">
                                        <button
                                            onClick={() => { onViewChange('scanner'); setShowMenu(false); }}
                                            className="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100"
                                        >
                                            Scanner
                                        </button>
                                        <button
                                            onClick={() => { onViewChange('history'); setShowMenu(false); }}
                                            className="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100"
                                        >
                                            History
                                        </button>
                                        <button
                                            onClick={() => { onViewChange('batches'); setShowMenu(false); }}
                                            className="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100"
                                        >
                                            Batches
                                        </button>
                                        {isSiteAdmin && (
                                            <a
                                                href="/admin.html"
                                                className="block px-4 py-2 text-purple-600 hover:bg-purple-50 font-medium"
                                            >
                                                Admin
                                            </a>
                                        )}
                                    </div>
                                    <button
                                        onClick={onSignOut}
                                        className="w-full text-left px-4 py-2 text-brand-red hover:bg-red-50"
                                    >
                                        Sign Out
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </header>
            );
        }

        // =====================================================
        // SESSION HISTORY COMPONENT
        // =====================================================
        function SessionHistory({ user, onLoadSession }) {
            const [sessions, setSessions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');

            useEffect(() => {
                loadSessions();
            }, []);

            const loadSessions = async () => {
                try {
                    let query = supabase
                        .from('sessions')
                        .select(`
                            *,
                            batches (batch_name, center_id, level),
                            reports (report_id, student_id)
                        `);
                    if (!DEBUG_MODE) {
                        query = query.eq('teacher_id', user.id);
                    }
                    const { data, error } = await query
                        .order('session_date', { ascending: false })
                        .limit(50);

                    if (error) throw error;
                    setSessions(data || []);
                } catch (err) {
                    setError('Failed to load sessions: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const deleteSession = async (sessionId) => {
                if (!confirm('Are you sure you want to delete this session? This will also delete all associated reports.')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('sessions')
                        .delete()
                        .eq('session_id', sessionId);

                    if (error) throw error;
                    setSessions(sessions.filter(c => c.session_id !== sessionId));
                } catch (err) {
                    setError('Failed to delete session: ' + err.message);
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-50 p-4">
                        <div className="max-w-4xl mx-auto pt-8 text-center">
                            <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-brand-teal border-t-transparent"></div>
                            <p className="mt-2 text-gray-600">Loading sessions...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-4xl mx-auto pt-4">
                        <div className="mb-6">
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">Session History</h2>
                            <p className="text-gray-600">View and manage your past grading sessions</p>
                        </div>

                        {error && (
                            <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-6">
                                {error}
                            </div>
                        )}

                        {sessions.length === 0 ? (
                            <div className="bg-white rounded-lg shadow p-8 text-center">
                                <p className="text-gray-600 mb-4">No sessions yet. Start by scanning a gradesheet!</p>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {sessions.map((cls) => (
                                    <div key={cls.session_id} className="bg-white rounded-lg shadow p-4">
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <h3 className="font-semibold text-gray-800">
                                                    {cls.batches?.batch_name || 'Unnamed Session'}
                                                </h3>
                                                <p className="text-sm text-gray-600">
                                                    {cls.batches?.level && cls.class_number && (
                                                        <span>Level {cls.batches.level}, Class {cls.class_number} - </span>
                                                    )}
                                                    {new Date(cls.session_date).toLocaleDateString('en-GB', {
                                                        weekday: 'long',
                                                        year: 'numeric',
                                                        month: 'long',
                                                        day: 'numeric'
                                                    })}
                                                </p>
                                                <div className="mt-2 flex gap-2">
                                                    <span className={`px-2 py-1 text-xs rounded ${
                                                        cls.status === 'sent' ? 'bg-green-100 text-green-700' :
                                                        cls.status === 'completed' ? 'bg-teal-100 text-brand-teal' :
                                                        'bg-gray-100 text-gray-700'
                                                    }`}>
                                                        {cls.status}
                                                    </span>
                                                    {cls.reports && (
                                                        <span className="px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded">
                                                            {cls.reports.length} reports
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => onLoadSession(cls)}
                                                    className="px-3 py-1 text-sm bg-brand-teal text-white rounded hover:bg-brand-teal-dark"
                                                >
                                                    View
                                                </button>
                                                <button
                                                    onClick={() => deleteSession(cls.session_id)}
                                                    className="px-3 py-1 text-sm text-red-600 border border-red-300 rounded hover:bg-red-50"
                                                >
                                                    Delete
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // =====================================================
        // BATCH MANAGEMENT COMPONENT
        // =====================================================
        function BatchManagement({ user }) {
            const [batches, setBatches] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [showAddForm, setShowAddForm] = useState(false);
            const [newBatchName, setNewBatchName] = useState('');
            const [centers, setCenters] = useState([]);
            const [selectedCenter, setSelectedCenter] = useState('');

            useEffect(() => {
                loadData();
            }, []);

            const loadData = async () => {
                try {
                    // Load batches
                    let batchQuery = supabase
                        .from('batches')
                        .select('*, centers(center_name), students(student_id, student_name)');
                    if (!DEBUG_MODE) {
                        batchQuery = batchQuery.eq('teacher_id', user.id);
                    }
                    const { data: batchData, error: batchError } = await batchQuery
                        .order('batch_name');

                    if (batchError) throw batchError;
                    setBatches(batchData || []);

                    // Load centers (for adding new batches)
                    const { data: centerData, error: centerError } = await supabase
                        .from('centers')
                        .select('*')
                        .eq('is_active', true);

                    if (centerError) throw centerError;
                    setCenters(centerData || []);
                    if (centerData?.length > 0) {
                        setSelectedCenter(centerData[0].center_id);
                    }
                } catch (err) {
                    setError('Failed to load data: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const addBatch = async () => {
                if (!newBatchName.trim() || !selectedCenter) return;

                try {
                    const { data, error } = await supabase
                        .from('batches')
                        .insert({
                            batch_name: newBatchName.trim(),
                            center_id: selectedCenter,
                            teacher_id: user.id
                        })
                        .select('*, centers(center_name)')
                        .single();

                    if (error) throw error;
                    setBatches([...batches, { ...data, students: [] }]);
                    setNewBatchName('');
                    setShowAddForm(false);
                } catch (err) {
                    setError('Failed to add batch: ' + err.message);
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-50 p-4">
                        <div className="max-w-4xl mx-auto pt-8 text-center">
                            <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-brand-teal border-t-transparent"></div>
                            <p className="mt-2 text-gray-600">Loading batches...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-4xl mx-auto pt-4">
                        <div className="mb-6 flex justify-between items-center">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">My Batches</h2>
                                <p className="text-gray-600">Manage your batches and students</p>
                            </div>
                            <button
                                onClick={() => setShowAddForm(true)}
                                className="px-4 py-2 bg-brand-teal text-white rounded-lg hover:bg-brand-teal-dark"
                            >
                                + Add Batch
                            </button>
                        </div>

                        {error && (
                            <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-6">
                                {error}
                            </div>
                        )}

                        {showAddForm && (
                            <div className="bg-white rounded-lg shadow p-4 mb-6">
                                <h3 className="font-semibold text-gray-800 mb-3">Add New Batch</h3>
                                <div className="flex gap-3">
                                    <input
                                        type="text"
                                        value={newBatchName}
                                        onChange={(e) => setNewBatchName(e.target.value)}
                                        placeholder="Batch name"
                                        className="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-brand-teal"
                                    />
                                    {centers.length > 0 && (
                                        <select
                                            value={selectedCenter}
                                            onChange={(e) => setSelectedCenter(e.target.value)}
                                            className="px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-brand-teal"
                                        >
                                            {centers.map(c => (
                                                <option key={c.center_id} value={c.center_id}>
                                                    {c.center_name}
                                                </option>
                                            ))}
                                        </select>
                                    )}
                                    <button
                                        onClick={addBatch}
                                        className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                                    >
                                        Add
                                    </button>
                                    <button
                                        onClick={() => setShowAddForm(false)}
                                        className="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-100"
                                    >
                                        Cancel
                                    </button>
                                </div>
                                {centers.length === 0 && (
                                    <p className="mt-2 text-sm text-amber-600">
                                        Note: No centers found. Please ask an admin to add you to a center.
                                    </p>
                                )}
                            </div>
                        )}

                        {batches.length === 0 ? (
                            <div className="bg-white rounded-lg shadow p-8 text-center">
                                <p className="text-gray-600 mb-4">No batches yet. Add your first batch to get started!</p>
                            </div>
                        ) : (
                            <div className="grid gap-4 md:grid-cols-2">
                                {batches.map((cls) => (
                                    <div key={cls.batch_id} className="bg-white rounded-lg shadow p-4">
                                        <h3 className="font-semibold text-gray-800">
                                            {cls.batch_code && <span className="text-brand-teal mr-2">{cls.batch_code}</span>}
                                            {cls.batch_name}
                                        </h3>
                                        <p className="text-sm text-gray-600">{cls.centers?.center_name}</p>
                                        <div className="mt-2">
                                            <span className="px-2 py-1 text-xs bg-teal-100 text-brand-teal rounded">
                                                {cls.students?.length || 0} students
                                            </span>
                                            {cls.level && (
                                                <span className="ml-2 px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded">
                                                    Level {cls.level}
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // =====================================================
        // MAIN SCANNER COMPONENT
        // =====================================================
        function Scanner({ user, initialSession }) {
            const [currentScreen, setCurrentScreen] = useState(initialSession ? 'edit' : 'upload');
            const [uploadedImage, setUploadedImage] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [activities, setActivities] = useState(initialSession?.ocr_processed?.activities || []);
            const [students, setStudents] = useState(initialSession?.ocr_processed?.students || []);
            const [reports, setReports] = useState([]);
            const [error, setError] = useState('');
            const [currentSessionId, setCurrentSessionId] = useState(initialSession?.session_id || null);
            const [selectedBatchId, setSelectedBatchId] = useState(initialSession?.batch_id || null);
            const [batches, setBatches] = useState([]);
            const [saveStatus, setSaveStatus] = useState('');
            const [isSavingReports, setIsSavingReports] = useState(false);
            const [colWidths, setColWidths] = useState({ name: 180, centerId: 120 });
            const [matchedStudentMap, setMatchedStudentMap] = useState([]);
            const [centerStudentsList, setCenterStudentsList] = useState([]);
            const [isMatching, setIsMatching] = useState(false);
            const [studentHistory, setStudentHistory] = useState({});
            const [showUploadOptions, setShowUploadOptions] = useState(false);
            const [extractedLevel, setExtractedLevel] = useState(initialSession?.ocr_processed?.level || null);
            const [extractedClassNumber, setExtractedClassNumber] = useState(initialSession?.ocr_processed?.classNumber || null);
            const [activityMapping, setActivityMapping] = useState(initialSession?.ocr_processed?.activityMapping || []);
            const [ocrWarnings, setOcrWarnings] = useState(initialSession?.ocr_processed?.warnings || []);

            const startResize = (colKey, e) => {
                e.preventDefault();
                const startX = e.clientX;
                const startWidth = colWidths[colKey];
                const onMouseMove = (ev) => {
                    const newWidth = Math.max(80, startWidth + ev.clientX - startX);
                    setColWidths(prev => ({ ...prev, [colKey]: newWidth }));
                };
                const onMouseUp = () => {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            };

            // Load teacher's batches on mount
            useEffect(() => {
                loadBatches();
            }, []);

            // Load existing reports if viewing a session
            useEffect(() => {
                if (initialSession?.session_id) {
                    loadSessionReports(initialSession.session_id);
                }
            }, [initialSession]);

            const loadBatches = async () => {
                let query = supabase
                    .from('batches')
                    .select('batch_id, batch_name, batch_code, center_id')
                    .eq('is_active', true);
                if (!DEBUG_MODE) {
                    query = query.eq('teacher_id', user.id);
                }
                const { data, error } = await query;

                if (!error && data) {
                    setBatches(data);
                }
            };

            // =====================================================
            // MATCH STUDENTS TO DATABASE
            // Fetches DB students for the selected batch, matches
            // OCR students by center_student_id or name, and stores
            // the result in matchedStudentMap for the session.
            // =====================================================
            const matchStudentsToDb = async (batchId, ocrStudents) => {
                if (!batchId || !ocrStudents || ocrStudents.length === 0) {
                    setMatchedStudentMap([]);
                    return [];
                }

                setIsMatching(true);
                debugLog('matchStudentsToDb', { batchId, studentCount: ocrStudents.length });

                try {
                    // Get center_id for the selected batch
                    const selectedBatch = batches.find(b => b.batch_id === batchId);
                    const centerId = selectedBatch?.center_id;

                    // Fetch students for the selected batch (for name matching)
                    const { data: batchStudents, error: studentError } = await supabase
                        .from('students')
                        .select('student_id, student_name, center_student_id, parent_id')
                        .eq('batch_id', batchId);

                    if (studentError) {
                        console.error('Error fetching students:', studentError);
                    }

                    // Fetch ALL students in the same center (for center_student_id matching)
                    let centerStudentData = [];
                    if (centerId) {
                        const { data: allBatchesInCenter } = await supabase
                            .from('batches')
                            .select('batch_id')
                            .eq('center_id', centerId);

                        if (allBatchesInCenter && allBatchesInCenter.length > 0) {
                            const allBatchIds = allBatchesInCenter.map(b => b.batch_id);
                            const { data: cStudents } = await supabase
                                .from('students')
                                .select('student_id, student_name, center_student_id, parent_id, batch_id')
                                .in('batch_id', allBatchIds);
                            centerStudentData = cStudents || [];
                        }
                    }

                    // Collect all unique parent IDs from both sets
                    const allStudents = [...(batchStudents || []), ...centerStudentData];
                    const parentIds = [...new Set(
                        allStudents
                            .filter(s => s.parent_id)
                            .map(s => s.parent_id)
                    )];

                    let parentsMap = {};
                    if (parentIds.length > 0) {
                        const { data: parentsData } = await supabase
                            .from('parents')
                            .select('parent_id, parent_name, phone')
                            .in('parent_id', parentIds);

                        if (parentsData) {
                            parentsData.forEach(p => {
                                parentsMap[p.parent_id] = p;
                            });
                        }
                    }

                    // Combine student data with parent info
                    const dbStudents = (batchStudents || []).map(s => ({
                        ...s,
                        parents: s.parent_id ? parentsMap[s.parent_id] : null
                    }));

                    const centerStudents = centerStudentData.map(s => ({
                        ...s,
                        parents: s.parent_id ? parentsMap[s.parent_id] : null
                    }));

                    setCenterStudentsList(centerStudents);

                    // Helper function to match OCR student with database student
                    const findDbStudent = (ocrStudent) => {
                        const ocrName = ocrStudent.name?.toLowerCase().trim();
                        const ocrRoll = ocrStudent.center_student_id?.toString().trim();

                        // First try center_student_id (center-wide)
                        if (ocrRoll) {
                            const paddedRoll = ocrRoll.padStart(4, '0');
                            const matchById = centerStudents.find(s =>
                                s.center_student_id?.toString().trim() === ocrRoll ||
                                s.center_student_id?.toString().trim() === paddedRoll
                            );
                            if (matchById) return matchById;
                        }

                        // Fallback to name matching (batch-level only)
                        for (const dbStudent of dbStudents) {
                            const dbName = dbStudent.student_name?.toLowerCase().trim();
                            if (dbName === ocrName) return dbStudent;
                            if (ocrName && dbName && ocrName.includes(dbName)) return dbStudent;
                            if (ocrName && dbName && dbName.includes(ocrName)) return dbStudent;
                            const ocrFirstName = ocrName?.split(/\s+/)[0];
                            const dbFirstName = dbName?.split(/\s+/)[0];
                            if (ocrFirstName && dbFirstName && ocrFirstName === dbFirstName && ocrFirstName.length > 2) return dbStudent;
                        }

                        return null;
                    };

                    // Match each OCR student
                    const matchMap = ocrStudents.map(ocrStudent => {
                        const dbStudent = findDbStudent(ocrStudent);
                        return dbStudent || null;
                    });

                    const matchedCount = matchMap.filter(m => m !== null).length;
                    debugLog('matchStudentsToDb result', {
                        total: ocrStudents.length,
                        matched: matchedCount,
                        unmatched: ocrStudents.length - matchedCount
                    });

                    setMatchedStudentMap(matchMap);

                    // Validate OCR center_student_ids and update names from DB
                    const validatedStudents = ocrStudents.map((student, i) => {
                        const ocrId = student.center_student_id?.toString().trim();
                        const matched = matchMap[i];
                        if (matched) {
                            return { ...student, center_student_id: matched.center_student_id?.toString().trim() || '', name: matched.student_name };
                        }
                        // Invalid OCR ID: clear it so dropdown shows blank
                        if (ocrId) {
                            const valid = centerStudents.find(s => s.center_student_id?.toString().trim() === ocrId || s.center_student_id?.toString().trim() === ocrId.padStart(4, '0'));
                            if (!valid) return { ...student, center_student_id: '' };
                        }
                        return student;
                    });
                    setStudents(validatedStudents);

                    return matchMap;
                } catch (err) {
                    console.error('Error matching students:', err);
                    setMatchedStudentMap([]);
                    return [];
                } finally {
                    setIsMatching(false);
                }
            };

            const loadSessionReports = async (sessionId) => {
                // Fetch reports with student info
                const { data: reportsData, error } = await supabase
                    .from('reports')
                    .select('report_id, session_id, student_id, report_body, sent_to, sent_at')
                    .eq('session_id', sessionId);

                if (error || !reportsData || reportsData.length === 0) {
                    console.log('No reports found for session:', sessionId);
                    return;
                }

                // Get student IDs that exist
                const studentIds = reportsData
                    .filter(r => r.student_id)
                    .map(r => r.student_id);

                // Fetch student info
                let studentsMap = {};
                let parentsMap = {};

                if (studentIds.length > 0) {
                    const { data: studentsData } = await supabase
                        .from('students')
                        .select('student_id, student_name, center_student_id, parent_id')
                        .in('student_id', studentIds);

                    if (studentsData) {
                        // Get parent IDs
                        const parentIds = studentsData
                            .filter(s => s.parent_id)
                            .map(s => s.parent_id);

                        // Fetch parents
                        if (parentIds.length > 0) {
                            const { data: parentsData } = await supabase
                                .from('parents')
                                .select('parent_id, parent_name, phone')
                                .in('parent_id', parentIds);

                            if (parentsData) {
                                parentsData.forEach(p => {
                                    parentsMap[p.parent_id] = p;
                                });
                            }
                        }

                        studentsData.forEach(s => {
                            studentsMap[s.student_id] = {
                                ...s,
                                parent: s.parent_id ? parentsMap[s.parent_id] : null
                            };
                        });
                    }
                }

                // Combine data
                setReports(reportsData.map(r => {
                    const student = r.student_id ? studentsMap[r.student_id] : null;
                    return {
                        reportId: r.report_id,
                        studentId: r.student_id,
                        studentName: student?.student_name || 'Unknown',
                        centerStudentId: student?.center_student_id || null,
                        parentPhone: student?.parent?.phone || null,
                        parentName: student?.parent?.parent_name || null,
                        report: r.report_body,
                        sentAt: r.sent_at
                    };
                }));
                setCurrentScreen('reports');
            };

            // Compress image before upload
            const compressImage = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onerror = () => reject(new Error('Failed to read image file'));
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onerror = () => reject(new Error('Failed to load image'));
                        img.onload = () => {
                            try {
                                const canvas = document.createElement('canvas');
                                let width = img.width;
                                let height = img.height;
                                
                                const maxDim = 1024;
                                if (width > maxDim || height > maxDim) {
                                    if (width > height) {
                                        height = (height / width) * maxDim;
                                        width = maxDim;
                                    } else {
                                        width = (width / height) * maxDim;
                                        height = maxDim;
                                    }
                                }
                                
                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                
                                // Set white background for JPEG
                                ctx.fillStyle = '#FFFFFF';
                                ctx.fillRect(0, 0, width, height);
                                
                                ctx.drawImage(img, 0, 0, width, height);
                                
                                // Try to get base64, with fallback
                                try {
                                    const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
                                    if (!dataUrl || dataUrl === 'data:,') {
                                        throw new Error('Canvas conversion failed');
                                    }
                                    resolve(dataUrl);
                                } catch (canvasError) {
                                    console.error('Canvas toDataURL failed:', canvasError);
                                    // Fallback: just use original file as base64
                                    resolve(e.target.result);
                                }
                            } catch (err) {
                                reject(err);
                            }
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };

            // Save session to database
            const saveSession = async (ocrData, imageBase64, batchIdOverride) => {
                try {
                    setSaveStatus('Saving...');

                    const effectiveBatchId = batchIdOverride || selectedBatchId;
                    if (!effectiveBatchId) {
                        console.warn('Cannot save session without batch_id');
                        setSaveStatus('');
                        setError('Please select a batch before saving.');
                        return null;
                    }

                    const sessionData = {
                        batch_id: effectiveBatchId,
                        teacher_id: user.id,
                        session_date: new Date().toISOString().split('T')[0],
                        ocr_raw: ocrData,
                        ocr_processed: ocrData,
                        class_number: ocrData.classNumber || null,
                        status: 'draft'
                    };

                    let sessionId = currentSessionId;

                    if (currentSessionId) {
                        const { error } = await supabase
                            .from('sessions')
                            .update(sessionData)
                            .eq('session_id', currentSessionId);
                        if (error) throw error;
                    } else {
                        const { data, error } = await supabase
                            .from('sessions')
                            .insert(sessionData)
                            .select()
                            .single();

                        if (error) throw error;
                        sessionId = data.session_id;
                        setCurrentSessionId(sessionId);
                    }

                    // Upload image to storage
                    if (imageBase64 && sessionId) {
                        try {
                            const base64Data = imageBase64.split(',')[1];
                            const byteCharacters = atob(base64Data);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            const blob = new Blob([byteArray], { type: 'image/jpeg' });

                            const filePath = `${user.id}/${sessionId}.jpg`;
                            const { error: uploadError } = await supabase.storage
                                .from('gradesheets')
                                .upload(filePath, blob, { upsert: true });

                            if (!uploadError) {
                                const { data: urlData } = supabase.storage
                                    .from('gradesheets')
                                    .getPublicUrl(filePath);

                                await supabase
                                    .from('sessions')
                                    .update({ scan_file_url: urlData.publicUrl })
                                    .eq('session_id', sessionId);
                            }
                        } catch (uploadErr) {
                            console.warn('Image upload failed (non-critical):', uploadErr);
                        }
                    }

                    setSaveStatus('Saved!');
                    setTimeout(() => setSaveStatus(''), 2000);
                    return sessionId;
                } catch (err) {
                    console.error('Save error:', err);
                    setSaveStatus('Save failed');
                    return null;
                }
            };

            // Handle image upload
            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setError('');
                setIsProcessing(true);

                try {
                    const compressedImage = await compressImage(file);
                    setUploadedImage(compressedImage);

                    const base64Image = compressedImage.split(',')[1];
                    
                    // Call our Edge Function instead of OpenAI directly
                    const data = await callOpenAI('extract', { image: base64Image });

                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        throw new Error('Could not read the image. Please upload a clearer photo of the gradesheet.');
                    }

                    let extractedText = data.choices[0].message.content.trim();
                    extractedText = extractedText.replace(/```json\n?/g, '').replace(/```\n?/g, '');
                    
                    let extractedData;
                    try {
                        extractedData = JSON.parse(extractedText);
                    } catch (parseErr) {
                        throw new Error('Could not extract data from this image. Please upload a clearer photo with visible student names and grades.');
                    }
                    
                    if (!extractedData.activities || !extractedData.students || extractedData.students.length === 0) {
                        throw new Error('No student data found in the image. Please ensure the gradesheet is clearly visible.');
                    }

                    setActivities(extractedData.activities);
                    setStudents(extractedData.students);

                    // Store enhanced OCR data
                    if (extractedData.level) setExtractedLevel(extractedData.level);
                    if (extractedData.classNumber) setExtractedClassNumber(extractedData.classNumber);
                    if (extractedData.activityMapping) setActivityMapping(extractedData.activityMapping);
                    if (extractedData.warnings) setOcrWarnings(extractedData.warnings);

                    // Auto-match batch from OCR-extracted batchCode
                    let autoBatchId = selectedBatchId;
                    if ((extractedData.batchCode || extractedData.classCode) && batches.length > 0) {
                        const ocrCode = (extractedData.batchCode || extractedData.classCode).trim();
                        const matchedBatch = batches.find(b => b.batch_code === ocrCode);
                        if (matchedBatch) {
                            autoBatchId = matchedBatch.batch_id;
                            setSelectedBatchId(autoBatchId);
                            debugLog('Auto-matched batch', { ocrCode, matchedName: matchedBatch.batch_name, batchId: autoBatchId });
                        } else {
                            console.warn('No batch match found for OCR batchCode:', ocrCode);
                        }
                    }

                    setCurrentScreen('edit');

                    // Auto-save to database (pass autoBatchId directly to avoid React state race condition)
                    await saveSession(extractedData, compressedImage, autoBatchId);

                    // Immediately match students to DB
                    if (autoBatchId) {
                        await matchStudentsToDb(autoBatchId, extractedData.students);
                    }
                } catch (err) {
                    setError(`Error: ${err.message}`);
                    console.error(err);
                } finally {
                    setIsProcessing(false);
                }
            };

            // Handle batch change — re-match students
            const handleBatchChange = async (newBatchId) => {
                setSelectedBatchId(newBatchId || null);
                if (newBatchId && students.length > 0) {
                    await matchStudentsToDb(newBatchId, students);
                } else {
                    setMatchedStudentMap([]);
                }
            };

            // Update functions
            const updateGrade = (studentIndex, activityIndex, value) => {
                const updated = [...students];
                updated[studentIndex].grades[activityIndex] = value;
                setStudents(updated);
            };

            const updateStudentName = (index, value) => {
                const updated = [...students];
                updated[index].name = value;
                setStudents(updated);
            };

            const updateStudentCenterId = (index, value) => {
                const updated = [...students];
                updated[index].center_student_id = value;
                const matchedCenterStudent = centerStudentsList.find(
                    s => s.center_student_id?.toString().trim() === value
                );
                if (matchedCenterStudent) {
                    updated[index].name = matchedCenterStudent.student_name;
                }
                setStudents(updated);
                setMatchedStudentMap(prev => {
                    const newMap = [...prev];
                    newMap[index] = matchedCenterStudent || null;
                    return newMap;
                });
            };

            const updateActivityName = (index, value) => {
                const updated = [...activities];
                updated[index] = value;
                setActivities(updated);
            };

            const addStudent = () => {
                setStudents([...students, {
                    name: '',
                    center_student_id: '',
                    grades: new Array(activities.length).fill('')
                }]);
            };

            const deleteStudent = (index) => {
                setStudents(students.filter((_, i) => i !== index));
                setMatchedStudentMap(prev => prev.filter((_, i) => i !== index));
            };

            const addActivity = () => {
                setActivities([...activities, '']);
                const updated = students.map(student => ({
                    ...student,
                    grades: [...student.grades, '']
                }));
                setStudents(updated);
            };

            const deleteActivity = (index) => {
                setActivities(activities.filter((_, i) => i !== index));
                const updated = students.map(student => ({
                    ...student,
                    grades: student.grades.filter((_, i) => i !== index)
                }));
                setStudents(updated);
            };

            // Save reports to database (only those with valid student_id)
            const saveReports = async (sessionId, generatedReports) => {
                if (!sessionId) return;

                // Filter to only reports with valid student_id (matched in database)
                const reportsToSave = generatedReports.filter(r => r.studentId);

                if (reportsToSave.length === 0) {
                    console.warn('No reports saved - none had valid student_id');
                    return;
                }

                try {
                    await supabase
                        .from('reports')
                        .delete()
                        .eq('session_id', sessionId);

                    const reportRecords = reportsToSave.map(r => ({
                        session_id: sessionId,
                        student_id: r.studentId,
                        report_body: r.report,
                        generated_by: user.id
                    }));

                    const { data: insertedReports } = await supabase
                        .from('reports')
                        .insert(reportRecords)
                        .select();

                    // Update the reports state with database IDs
                    if (insertedReports) {
                        setReports(prev => prev.map(r => {
                            const inserted = insertedReports.find(ir => ir.student_id === r.studentId);
                            return inserted ? { ...r, reportId: inserted.report_id } : r;
                        }));
                    }

                    await supabase
                        .from('sessions')
                        .update({ status: 'completed' })
                        .eq('session_id', sessionId);

                    console.log(`Saved ${reportsToSave.length} reports to database`);
                } catch (err) {
                    console.error('Failed to save reports:', err);
                }
            };

            // Generate reports
            const generateReports = async () => {
                setError('');

                if (!selectedBatchId) {
                    setError('Please select a batch before generating reports.');
                    return;
                }

                setIsProcessing(true);

                debugLog('STARTING REPORT GENERATION', {
                    studentCount: students.length,
                    batchId: selectedBatchId,
                    matchedCount: matchedStudentMap.filter(m => m !== null).length
                });

                try {
                    const sessionId = await saveSession(
                        { activities, students },
                        uploadedImage
                    );

                    // Always re-match before generating reports (user may have changed selections)
                    let currentMatches = matchedStudentMap;
                    if (selectedBatchId) {
                        currentMatches = await matchStudentsToDb(selectedBatchId, students);
                    }

                    // Track unmatched students
                    const unmatchedStudents = students
                        .filter((_, i) => !currentMatches[i])
                        .map(s => s.name);

                    if (unmatchedStudents.length > 0) {
                        console.warn('Unmatched students:', unmatchedStudents);
                    }

                    // Build activity definitions from mapping if available
                    const activityDefinitions = activityMapping && activityMapping.length > 0
                        ? activityMapping.map(mapping => ({
                            activityName: mapping.dbName || mapping.ocrName,
                            description: mapping.description,
                            learningArea: mapping.learningArea
                          }))
                        : null;

                    // Generate reports in parallel using stored matches
                    const reportPromises = students.map(async (student, index) => {
                        const activityGrades = activities.map((activity, idx) =>
                            `${activity}: ${student.grades[idx] || 'Not graded'}`
                        ).join('\n');

                        const data = await callOpenAI('generate_report', {
                            studentName: student.name,
                            activityGrades: activityGrades,
                            activityDefinitions: activityDefinitions,
                            level: extractedLevel,
                            classNumber: extractedClassNumber
                        });

                        const content = data.choices?.[0]?.message?.content?.trim() || '';
                        const dbStudent = currentMatches[index];

                        return {
                            studentName: student.name,
                            studentId: dbStudent?.student_id || null,
                            centerStudentId: dbStudent?.center_student_id || null,
                            parentPhone: dbStudent?.parents?.phone || null,
                            parentName: dbStudent?.parents?.parent_name || null,
                            report: content,
                            matchedInDb: !!dbStudent,
                            _rawResponse: data
                        };
                    });

                    const results = await Promise.allSettled(reportPromises);

                    const generatedReports = [];
                    const failedStudents = [];

                    results.forEach((result, index) => {
                        if (result.status === 'fulfilled') {
                            const report = result.value;
                            if (report.report && report.report.length > 0) {
                                generatedReports.push({
                                    studentId: report.studentId,
                                    studentName: report.studentName,
                                    centerStudentId: report.centerStudentId,
                                    parentPhone: report.parentPhone,
                                    parentName: report.parentName,
                                    report: report.report,
                                    matchedInDb: report.matchedInDb
                                });
                            } else {
                                failedStudents.push({
                                    name: report.studentName,
                                    error: 'Empty response from API'
                                });
                            }
                        } else {
                            failedStudents.push({
                                name: students[index].name,
                                error: result.reason?.message || 'Unknown error'
                            });
                        }
                    });

                    // Build warning message
                    let warningMsg = '';
                    if (failedStudents.length > 0) {
                        warningMsg += `Could not generate reports for: ${failedStudents.map(s => s.name).join(', ')}. `;
                    }
                    if (unmatchedStudents.length > 0) {
                        warningMsg += `Students not found in database (reports won't be saved): ${unmatchedStudents.join(', ')}. `;
                    }
                    if (warningMsg) {
                        setError(`Warning: ${warningMsg}${generatedReports.length} reports were generated.`);
                    }

                    if (generatedReports.length === 0) {
                        throw new Error('No reports could be generated. Please try again.');
                    }

                    setReports(generatedReports);
                    setCurrentScreen('reports');

                    await saveReports(sessionId, generatedReports);
                } catch (err) {
                    setError(`Error generating reports: ${err.message}`);
                    console.error(err);
                } finally {
                    setIsProcessing(false);
                }
            };

            // Download report
            const downloadReport = (studentName, report) => {
                const element = document.createElement('a');
                const file = new Blob([`Report for ${studentName}\n\n${report}`], {type: 'text/plain'});
                element.href = URL.createObjectURL(file);
                element.download = `${studentName.replace(/\s+/g, '_')}_report.txt`;
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            };

            // Download all reports
            const downloadAllReports = () => {
                const allContent = reports.map(r =>
                    `${'='.repeat(50)}\nReport for ${r.studentName}\n${'='.repeat(50)}\n\n${r.report}\n\n`
                ).join('\n');

                const element = document.createElement('a');
                const file = new Blob([allContent], {type: 'text/plain'});
                element.href = URL.createObjectURL(file);
                element.download = `all_reports_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            };

            // Update report text when edited
            const updateReportText = (index, newText) => {
                const updated = [...reports];
                updated[index] = { ...updated[index], report: newText };
                setReports(updated);
            };

            // Save all edited reports to database
            const saveAllReportEdits = async () => {
                if (!currentSessionId) {
                    setError('No session ID found. Cannot save reports.');
                    return;
                }

                // Filter to only reports with valid student_id (matched in database)
                const reportsToSave = reports.filter(r => r.studentId);
                const unmatchedReports = reports.filter(r => !r.studentId);

                if (reportsToSave.length === 0) {
                    setError('No reports can be saved - none of the students were matched in the database.');
                    return;
                }

                setIsSavingReports(true);
                setError('');

                try {
                    // Delete existing reports for this session
                    await supabase
                        .from('reports')
                        .delete()
                        .eq('session_id', currentSessionId);

                    // Insert updated reports (only those with valid student_id)
                    const reportRecords = reportsToSave.map(r => ({
                        session_id: currentSessionId,
                        student_id: r.studentId,
                        report_body: r.report,
                        generated_by: user.id
                    }));

                    const { data: insertedReports, error: insertError } = await supabase
                        .from('reports')
                        .insert(reportRecords)
                        .select();

                    if (insertError) throw insertError;

                    // Update local state with report IDs from database
                    if (insertedReports) {
                        const updatedReports = reports.map(r => {
                            const inserted = insertedReports.find(ir => ir.student_id === r.studentId);
                            return inserted ? { ...r, reportId: inserted.report_id } : r;
                        });
                        setReports(updatedReports);
                    }

                    let message = `${reportsToSave.length} report(s) saved!`;
                    if (unmatchedReports.length > 0) {
                        message += ` (${unmatchedReports.length} skipped - students not in database)`;
                    }
                    setSaveStatus(message);
                    setTimeout(() => setSaveStatus(''), 3000);
                } catch (err) {
                    setError('Failed to save reports: ' + err.message);
                } finally {
                    setIsSavingReports(false);
                }
            };

            // Send single report via WhatsApp
            const sendViaWhatsApp = async (report, index) => {
                // Format the message for WhatsApp
                const message = `Report for ${report.studentName}\n\n${report.report}`;
                const encodedMessage = encodeURIComponent(message);

                let phone = null;
                // If parent phone exists, open WhatsApp directly to that number
                // Otherwise, open WhatsApp with the message to let user select contact
                if (report.parentPhone) {
                    // Remove any non-numeric characters and ensure it starts with country code
                    phone = report.parentPhone.replace(/\D/g, '');
                    // If phone doesn't start with country code, assume Singapore (+65)
                    if (phone.length === 8) {
                        phone = '65' + phone;
                    }
                    window.open(`https://wa.me/${phone}?text=${encodedMessage}`, '_blank');
                } else {
                    // No phone number - open WhatsApp with message, user will select contact
                    window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
                }

                // Update sent_to and sent_at in database if we have a reportId
                if (report.reportId && report.studentId) {
                    try {
                        await supabase
                            .from('reports')
                            .update({
                                sent_to: phone ? `whatsapp:${phone}` : 'whatsapp:manual',
                                sent_at: new Date().toISOString()
                            })
                            .eq('report_id', report.reportId);

                        // Update local state to reflect sent status
                        if (typeof index === 'number') {
                            const updated = [...reports];
                            updated[index] = { ...updated[index], sentAt: new Date().toISOString() };
                            setReports(updated);
                        }
                    } catch (err) {
                        console.error('Failed to update sent status:', err);
                    }
                }
            };

            // Send all reports via WhatsApp (opens multiple tabs)
            const sendAllViaWhatsApp = () => {
                const reportsWithPhone = reports.filter(r => r.parentPhone);
                const reportsWithoutPhone = reports.filter(r => !r.parentPhone);

                if (reportsWithoutPhone.length > 0) {
                    const proceed = confirm(
                        `${reportsWithoutPhone.length} student(s) don't have parent phone numbers stored:\n` +
                        `${reportsWithoutPhone.map(r => r.studentName).join(', ')}\n\n` +
                        `Would you like to proceed with sending ${reportsWithPhone.length} report(s) to parents with phone numbers?`
                    );
                    if (!proceed) return;
                }

                if (reportsWithPhone.length === 0) {
                    alert('No parent phone numbers found. Please add parent phone numbers to student records in the database.');
                    return;
                }

                // Warn user about multiple tabs
                const confirmSend = confirm(
                    `This will open ${reportsWithPhone.length} WhatsApp tab(s). ` +
                    `You'll need to click "Send" in each tab.\n\nProceed?`
                );

                if (confirmSend) {
                    reportsWithPhone.forEach((report, index) => {
                        // Stagger the opening of tabs to avoid browser blocking
                        setTimeout(() => {
                            sendViaWhatsApp(report);
                        }, index * 500);
                    });
                }
            };

            // Load past reports for a student
            const loadStudentHistory = async (studentId) => {
                if (!studentId || studentHistory[studentId]) return;

                try {
                    const { data, error } = await supabase
                        .from('reports')
                        .select(`
                            report_id, report_body, created_at, sent_at,
                            sessions (session_id, session_date, batches (batch_name))
                        `)
                        .eq('student_id', studentId)
                        .neq('session_id', currentSessionId)
                        .order('created_at', { ascending: false })
                        .limit(10);

                    if (error) throw error;

                    setStudentHistory(prev => ({
                        ...prev,
                        [studentId]: data || []
                    }));
                } catch (err) {
                    console.error('Failed to load student history:', err);
                    setStudentHistory(prev => ({
                        ...prev,
                        [studentId]: []
                    }));
                }
            };

            // Upload Screen
            if (currentScreen === 'upload') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-brand-cream to-white p-4">
                        <div className="max-w-2xl mx-auto pt-8">
                            <h2 className="text-3xl font-bold text-gray-800 mb-2 text-center">Scan Gradesheet</h2>
                            <p className="text-gray-600 mb-8 text-center">Upload or photograph a gradesheet to extract data</p>

                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-6">
                                    {error}
                                </div>
                            )}

                            <div className="bg-white rounded-lg shadow-lg p-8">
                                <button 
                                    onClick={() => setShowUploadOptions(true)}
                                    disabled={isProcessing}
                                    className="flex flex-col items-center justify-center w-full h-64 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    <div className="flex flex-col items-center justify-center pt-5 pb-6">
                                        <svg className="w-16 h-16 mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                        </svg>
                                        <p className="mb-2 text-lg font-medium text-gray-700">
                                            {isProcessing ? 'Processing...' : 'Upload Gradesheet'}
                                        </p>
                                        <p className="text-sm text-gray-500">Click to choose camera or upload</p>
                                    </div>
                                </button>

                                {isProcessing && (
                                    <div className="mt-6 text-center">
                                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-brand-teal border-t-transparent"></div>
                                        <p className="mt-2 text-gray-600">Extracting student data...</p>
                                    </div>
                                )}
                            </div>
                            
                            {/* Upload Options Modal */}
                            {showUploadOptions && (
                                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                    <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                                        <h3 className="text-xl font-bold text-gray-800 mb-4">Choose Image Source</h3>
                                        <div className="space-y-3">
                                            <label className="flex items-center justify-center w-full p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                                                <svg className="w-6 h-6 mr-3 text-brand-teal" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                                </svg>
                                                <span className="font-medium text-gray-700">Take Photo</span>
                                                <input
                                                    type="file"
                                                    accept="image/*"
                                                    capture="environment"
                                                    onChange={(e) => {
                                                        setShowUploadOptions(false);
                                                        handleImageUpload(e);
                                                    }}
                                                    className="hidden"
                                                />
                                            </label>
                                            
                                            <label className="flex items-center justify-center w-full p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                                                <svg className="w-6 h-6 mr-3 text-brand-teal" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                                <span className="font-medium text-gray-700">Upload from Gallery</span>
                                                <input
                                                    type="file"
                                                    accept="image/*"
                                                    onChange={(e) => {
                                                        setShowUploadOptions(false);
                                                        handleImageUpload(e);
                                                    }}
                                                    className="hidden"
                                                />
                                            </label>
                                        </div>
                                        
                                        <button
                                            onClick={() => setShowUploadOptions(false)}
                                            className="mt-4 w-full px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // Edit Grid Screen
            if (currentScreen === 'edit') {
                return (
                    <div className="min-h-screen bg-gray-50 p-4">
                        <div className="max-w-7xl mx-auto pt-4">
                            <div className="mb-6 flex justify-between items-center">
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-800 mb-1">Review & Edit Data</h2>
                                    <p className="text-gray-600">Make any necessary corrections before generating reports</p>
                                </div>
                                {saveStatus && (
                                    <span className={`px-3 py-1 rounded text-sm ${
                                        saveStatus === 'Saved!' ? 'bg-green-100 text-green-700' :
                                        saveStatus === 'Save failed' ? 'bg-red-100 text-red-700' :
                                        'bg-gray-100 text-gray-700'
                                    }`}>
                                        {saveStatus}
                                    </span>
                                )}
                            </div>

                            {ocrWarnings && ocrWarnings.length > 0 && (
                                <div className="mb-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                                    <h3 className="text-sm font-semibold text-amber-800 mb-2">⚠️ Activity Mapping Warnings</h3>
                                    <ul className="text-sm text-amber-700 space-y-1">
                                        {ocrWarnings.map((warning, idx) => (
                                            <li key={idx}>• {warning}</li>
                                        ))}
                                    </ul>
                                </div>
                            )}

                            {extractedLevel && extractedClassNumber && (
                                <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                    <p className="text-sm text-blue-800">
                                        📚 Detected: <span className="font-semibold">Level {extractedLevel}, Class {extractedClassNumber}</span>
                                        {activityMapping && activityMapping.length > 0 && (
                                            <span className="ml-2 text-green-700">✓ Using predefined activity sequence</span>
                                        )}
                                    </p>
                                </div>
                            )}

                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Batch</label>
                                <select
                                    value={selectedBatchId || ''}
                                    onChange={(e) => handleBatchChange(e.target.value)}
                                    className="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal"
                                >
                                    <option value="">-- Select a batch --</option>
                                    {batches.map(c => (
                                        <option key={c.batch_id} value={c.batch_id}>
                                            {c.batch_code ? `${c.batch_code} — ${c.batch_name}` : c.batch_name}
                                        </option>
                                    ))}
                                </select>
                                {!selectedBatchId && (
                                    <p className="mt-1 text-sm text-amber-600">
                                        Please select a batch so students can be matched to database records.
                                    </p>
                                )}
                                {isMatching && (
                                    <p className="mt-1 text-sm text-brand-teal">Matching students...</p>
                                )}
                                {!isMatching && selectedBatchId && matchedStudentMap.length > 0 && (
                                    <p className="mt-1 text-sm text-green-700">
                                        {matchedStudentMap.filter(m => m !== null).length} of {students.length} students matched
                                    </p>
                                )}
                            </div>

                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-6">
                                    {error}
                                </div>
                            )}

                            <div className="mb-3 flex items-center gap-4 text-xs text-gray-500">
                                <span className="font-semibold text-gray-600">Grade key:</span>
                                <span><strong>A</strong> = Excellent</span>
                                <span><strong>B</strong> = Good</span>
                                <span><strong>C</strong> = Needs Practice</span>
                                <span><strong>X</strong> = Absent</span>
                            </div>

                            <div className="bg-white rounded-lg shadow overflow-x-auto">
                                <table className="border-collapse" style={{ tableLayout: 'fixed', width: colWidths.name + colWidths.centerId + activities.length * 100 + 80 }}>
                                    <colgroup>
                                        <col style={{ width: colWidths.name }} />
                                        <col style={{ width: colWidths.centerId }} />
                                        {activities.map((_, i) => (
                                            <col key={i} style={{ width: 100 }} />
                                        ))}
                                        <col style={{ width: 80 }} />
                                    </colgroup>
                                    <thead className="bg-gray-100 border-b-2 border-gray-300">
                                        <tr>
                                            <th className="px-3 py-3 text-left text-sm font-semibold text-gray-700 border-r border-gray-300 sticky left-0 bg-gray-100" style={{ position: 'relative' }}>
                                                Student Name
                                                <div onMouseDown={(e) => startResize('name', e)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: 6, cursor: 'col-resize', zIndex: 1 }} onMouseOver={(e) => e.currentTarget.style.background='#cbd5e1'} onMouseOut={(e) => e.currentTarget.style.background='transparent'} />
                                            </th>
                                            <th className="px-3 py-3 text-left text-sm font-semibold text-gray-700 border-r border-gray-300 bg-gray-100" style={{ position: 'relative' }}>
                                                Center Student ID
                                                <div onMouseDown={(e) => startResize('centerId', e)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: 6, cursor: 'col-resize', zIndex: 1 }} onMouseOver={(e) => e.currentTarget.style.background='#cbd5e1'} onMouseOut={(e) => e.currentTarget.style.background='transparent'} />
                                            </th>
                                            {activities.map((activity, index) => (
                                                <th key={index} className="px-3 py-3 text-center text-sm font-semibold text-gray-700">
                                                    <input
                                                        type="text"
                                                        value={activity}
                                                        onChange={(e) => updateActivityName(index, e.target.value)}
                                                        className="w-full px-2 py-1 border border-gray-300 rounded text-center focus:ring-2 focus:ring-brand-teal"
                                                    />
                                                    <button
                                                        onClick={() => deleteActivity(index)}
                                                        className="mt-1 text-xs text-red-600 hover:text-red-800"
                                                    >
                                                        Delete
                                                    </button>
                                                </th>
                                            ))}
                                            <th className="px-3 py-3 text-center text-sm font-semibold text-gray-700">
                                                <button
                                                    onClick={addActivity}
                                                    className="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                                                >
                                                    + Activity
                                                </button>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {students.map((student, studentIndex) => {
                                            const matched = matchedStudentMap[studentIndex];
                                            return (
                                            <tr key={studentIndex} className={`border-b hover:bg-gray-50 ${matched ? '' : selectedBatchId ? 'bg-amber-50' : ''}`}>
                                                <td className={`px-3 py-3 border-r border-gray-300 sticky left-0 ${matched ? 'bg-white' : selectedBatchId ? 'bg-amber-50' : 'bg-white'}`}>
                                                    <div className="flex items-center gap-1">
                                                        {selectedBatchId && matchedStudentMap.length > 0 && (
                                                            <span title={matched ? `Matched: ${matched.student_name}` : 'Not found in database'} className="flex-shrink-0">
                                                                {matched
                                                                    ? <svg className="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M5 13l4 4L19 7"/></svg>
                                                                    : <svg className="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01M12 3a9 9 0 100 18 9 9 0 000-18z"/></svg>
                                                                }
                                                            </span>
                                                        )}
                                                        <span className="w-full px-2 py-1 text-gray-800">{student.name || '—'}</span>
                                                    </div>
                                                </td>
                                                <td className={`px-3 py-3 border-r border-gray-300 ${matched ? 'bg-white' : selectedBatchId ? 'bg-amber-50' : 'bg-white'}`}>
                                                    <select
                                                        value={student.center_student_id || ''}
                                                        onChange={(e) => updateStudentCenterId(studentIndex, e.target.value)}
                                                        className="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-brand-teal"
                                                    >
                                                        <option value="">-- Select Student --</option>
                                                        {(() => {
                                                            const usedIds = students
                                                                .filter((_, i) => i !== studentIndex)
                                                                .map(s => s.center_student_id?.toString().trim())
                                                                .filter(Boolean);
                                                            return centerStudentsList
                                                                .filter(cs => !usedIds.includes(cs.center_student_id?.toString().trim()))
                                                                .sort((a, b) => (a.center_student_id || '').localeCompare(b.center_student_id || ''))
                                                                .map(cs => (
                                                                    <option key={cs.student_id} value={cs.center_student_id?.toString().trim()}>
                                                                        {cs.center_student_id} - {cs.student_name}
                                                                    </option>
                                                                ));
                                                        })()}
                                                    </select>
                                                </td>
                                                {student.grades.map((grade, gradeIndex) => (
                                                    <td key={gradeIndex} className="px-3 py-3 text-center">
                                                        <select
                                                            value={grade}
                                                            onChange={(e) => updateGrade(studentIndex, gradeIndex, e.target.value)}
                                                            className="px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-brand-teal text-center"
                                                        >
                                                            <option value="">-</option>
                                                            <option value="A">A</option>
                                                            <option value="B">B</option>
                                                            <option value="C">C</option>
                                                            <option value="X">X</option>
                                                        </select>
                                                    </td>
                                                ))}
                                                <td className="px-3 py-3 text-center">
                                                    <button
                                                        onClick={() => deleteStudent(studentIndex)}
                                                        className="text-red-600 hover:text-red-800 font-medium text-sm"
                                                    >
                                                        Delete
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                        })}
                                    </tbody>
                                </table>
                            </div>

                            <div className="mt-6 flex gap-4 flex-wrap">
                                <button
                                    onClick={addStudent}
                                    className="px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition"
                                >
                                    + Add Student
                                </button>
                                <button
                                    onClick={async () => {
                                        if (!selectedBatchId) {
                                            setError('Please select a batch before saving.');
                                            return;
                                        }
                                        await saveSession({ activities, students }, uploadedImage);
                                    }}
                                    className="px-6 py-3 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700 transition"
                                >
                                    Save Draft
                                </button>
                                <button
                                    onClick={async () => {
                                        // Delete draft session from DB if it exists and has no reports
                                        if (currentSessionId) {
                                            try {
                                                const { count } = await supabase
                                                    .from('reports')
                                                    .select('*', { count: 'exact', head: true })
                                                    .eq('session_id', currentSessionId);
                                                if (count === 0) {
                                                    await supabase
                                                        .from('sessions')
                                                        .delete()
                                                        .eq('session_id', currentSessionId)
                                                        .eq('status', 'draft');
                                                }
                                            } catch (err) {
                                                console.warn('Failed to clean up draft session:', err);
                                            }
                                        }
                                        setCurrentScreen('upload');
                                        setStudents([]);
                                        setActivities([]);
                                        setUploadedImage(null);
                                        setCurrentSessionId(null);
                                        setMatchedStudentMap([]);
                                        setStudentHistory({});
                                    }}
                                    className="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition"
                                >
                                    Start Over
                                </button>
                                <button
                                    onClick={generateReports}
                                    disabled={isProcessing || !selectedBatchId || students.length === 0 || students.some(s => !s.name.trim()) || (matchedStudentMap.length > 0 && matchedStudentMap.some(m => m === null))}
                                    className="ml-auto px-8 py-3 bg-brand-teal text-white rounded-lg font-medium hover:bg-brand-teal-dark disabled:bg-gray-400 disabled:cursor-not-allowed transition"
                                    title={matchedStudentMap.length > 0 && matchedStudentMap.some(m => m === null) ? 'All students must be matched before generating reports' : ''}
                                >
                                    {isProcessing ? 'Generating...' : 'Generate Reports'}
                                </button>
                            </div>

                            {!isProcessing && selectedBatchId && matchedStudentMap.length > 0 && matchedStudentMap.some(m => m === null) && (
                                <p className="mt-3 text-sm text-amber-700 bg-amber-50 border border-amber-200 px-4 py-2 rounded-lg">
                                    All students must be matched to database records before generating reports. Use the Center Student ID dropdown to match unmatched students, or use + Add Student and pick them from the dropdown.
                                </p>
                            )}

                            {isProcessing && (
                                <div className="mt-6 text-center">
                                    <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-brand-teal border-t-transparent"></div>
                                    <p className="mt-2 text-gray-600">Creating personalized reports...</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // Reports Screen
            if (currentScreen === 'reports') {
                return (
                    <div className="min-h-screen bg-gray-50 p-4">
                        <div className="max-w-4xl mx-auto pt-4">
                            <div className="mb-6">
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">Generated Reports</h2>
                                <p className="text-gray-600">Review, edit, and send individual student reports</p>
                            </div>

                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-6">
                                    {error}
                                </div>
                            )}

                            <div className="mb-4 flex flex-wrap gap-3">
                                <button
                                    onClick={downloadAllReports}
                                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
                                >
                                    Download All Reports
                                </button>
                                <button
                                    onClick={saveAllReportEdits}
                                    disabled={isSavingReports}
                                    className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition"
                                >
                                    {isSavingReports ? 'Saving...' : 'Save All Changes'}
                                </button>
                                <button
                                    onClick={sendAllViaWhatsApp}
                                    className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition flex items-center gap-2"
                                >
                                    <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                    </svg>
                                    Send All via WhatsApp
                                </button>
                            </div>

                            <div className="space-y-4">
                                {reports.map((report, index) => (
                                    <div key={index} className={`bg-white rounded-lg shadow p-6 ${!report.studentId ? 'border-l-4 border-amber-400' : ''}`}>
                                        <div className="flex justify-between items-start mb-3">
                                            <div>
                                                <div className="flex items-center gap-2">
                                                    <h3 className="text-xl font-semibold text-gray-800">{report.studentName}</h3>
                                                    {report.sentAt && (
                                                        <span className="px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded">Sent</span>
                                                    )}
                                                    {!report.studentId && (
                                                        <span className="px-2 py-0.5 text-xs bg-amber-100 text-amber-700 rounded" title="This student was not found in the database">Not in DB</span>
                                                    )}
                                                </div>
                                                {report.parentName && (
                                                    <p className="text-sm text-gray-600">Parent: {report.parentName}</p>
                                                )}
                                                {report.parentPhone && (
                                                    <p className="text-sm text-gray-500">Phone: {report.parentPhone}</p>
                                                )}
                                                {!report.studentId && (
                                                    <p className="text-xs text-amber-600 mt-1">Report won't be saved - student not found in database</p>
                                                )}
                                            </div>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => sendViaWhatsApp(report, index)}
                                                    className="px-3 py-2 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition flex items-center gap-1"
                                                    title={report.parentPhone ? `Send to ${report.parentPhone}` : 'No phone number - will open WhatsApp to select contact'}
                                                >
                                                    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                                    </svg>
                                                    {report.sentAt ? 'Resend' : 'WhatsApp'}
                                                </button>
                                                <button
                                                    onClick={() => downloadReport(report.studentName, report.report)}
                                                    className="px-3 py-2 bg-brand-teal text-white text-sm rounded hover:bg-brand-teal-dark transition"
                                                >
                                                    Download
                                                </button>
                                            </div>
                                        </div>
                                        <textarea
                                            value={report.report}
                                            onChange={(e) => updateReportText(index, e.target.value)}
                                            className="w-full h-48 p-3 border border-gray-300 rounded-lg text-gray-700 leading-relaxed focus:ring-2 focus:ring-brand-teal focus:border-transparent resize-y"
                                            placeholder="Report content..."
                                        />
                                        <div className="mt-2 flex items-center justify-between">
                                            <p className="text-xs text-gray-500">You can edit the report text above before sending</p>
                                            {report.studentId && (
                                                <button
                                                    onClick={() => loadStudentHistory(report.studentId)}
                                                    className="text-xs text-brand-teal hover:underline"
                                                >
                                                    {studentHistory[report.studentId] ? 'Hide History' : 'View History'}
                                                </button>
                                            )}
                                        </div>
                                        {report.studentId && studentHistory[report.studentId] && (
                                            <div className="mt-3 border-t border-gray-200 pt-3">
                                                <h4 className="text-sm font-semibold text-gray-700 mb-2">Past Reports ({studentHistory[report.studentId].length})</h4>
                                                {studentHistory[report.studentId].length === 0 ? (
                                                    <p className="text-xs text-gray-500">No previous reports found for this student.</p>
                                                ) : (
                                                    <div className="space-y-2 max-h-60 overflow-y-auto">
                                                        {studentHistory[report.studentId].map((hist) => (
                                                            <div key={hist.report_id} className="bg-gray-50 rounded p-3 text-sm">
                                                                <div className="flex items-center gap-2 mb-1">
                                                                    <span className="font-medium text-gray-700">
                                                                        {new Date(hist.sessions?.session_date || hist.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}
                                                                    </span>
                                                                    {hist.sessions?.batches?.batch_name && (
                                                                        <span className="text-xs bg-teal-50 text-brand-teal px-2 py-0.5 rounded">
                                                                            {hist.sessions.batches.batch_name}
                                                                        </span>
                                                                    )}
                                                                    {hist.sent_at && (
                                                                        <span className="text-xs bg-green-50 text-green-700 px-2 py-0.5 rounded">Sent</span>
                                                                    )}
                                                                </div>
                                                                <p className="text-gray-600 text-xs whitespace-pre-line line-clamp-3">{hist.report_body}</p>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>

                            <div className="mt-8 flex gap-4">
                                <button
                                    onClick={() => {
                                        setCurrentScreen('upload');
                                        setStudents([]);
                                        setActivities([]);
                                        setReports([]);
                                        setUploadedImage(null);
                                        setCurrentSessionId(null);
                                        setMatchedStudentMap([]);
                                        setStudentHistory({});
                                    }}
                                    className="px-6 py-3 bg-brand-teal text-white rounded-lg font-medium hover:bg-brand-teal-dark transition"
                                >
                                    Process Another Gradesheet
                                </button>
                                <button
                                    onClick={() => setCurrentScreen('edit')}
                                    className="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition"
                                >
                                    Back to Edit
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        }

        // =====================================================
        // PASSWORD RESET COMPONENT
        // =====================================================
        function PasswordResetScreen({ onComplete }) {
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setMessage('');

                if (newPassword !== confirmPassword) {
                    setError('Passwords do not match');
                    return;
                }

                if (newPassword.length < 6) {
                    setError('Password must be at least 6 characters');
                    return;
                }

                setLoading(true);

                try {
                    const { error } = await supabase.auth.updateUser({
                        password: newPassword
                    });

                    if (error) throw error;

                    setMessage('Password updated successfully!');
                    
                    // Clear the URL hash so refresh doesn't show reset screen again
                    window.history.replaceState(null, '', window.location.pathname);
                    
                    setTimeout(() => {
                        onComplete();
                    }, 1500);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-brand-cream to-white flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                        <h1 className="text-3xl font-bold text-gray-800 mb-2">Reset Password</h1>
                        <p className="text-gray-600 mb-6">Enter your new password</p>

                        {error && (
                            <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-4">
                                {error}
                            </div>
                        )}

                        {message && (
                            <div className="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg mb-4">
                                {message}
                            </div>
                        )}

                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    New Password
                                </label>
                                <input
                                    type="password"
                                    value={newPassword}
                                    onChange={(e) => setNewPassword(e.target.value)}
                                    placeholder="••••••••"
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent"
                                    required
                                    minLength={6}
                                />
                            </div>

                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Confirm New Password
                                </label>
                                <input
                                    type="password"
                                    value={confirmPassword}
                                    onChange={(e) => setConfirmPassword(e.target.value)}
                                    placeholder="••••••••"
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent"
                                    required
                                    minLength={6}
                                />
                            </div>

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-brand-teal text-white py-3 rounded-lg font-medium hover:bg-brand-teal-dark disabled:bg-gray-400 disabled:cursor-not-allowed transition"
                            >
                                {loading ? 'Updating...' : 'Update Password'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // =====================================================
        // DEBUG PANEL COMPONENT (for site_admin)
        // =====================================================
        function DebugPanel() {
            const [expanded, setExpanded] = useState(false);
            
            if (!DEBUG_MODE) return null;
            
            return (
                <div className="fixed bottom-4 right-4 z-50">
                    <button 
                        onClick={() => setExpanded(!expanded)}
                        className="bg-gray-800 text-white px-3 py-2 rounded-lg text-sm"
                    >
                        🐛 Debug ({DEBUG_LOGS.length})
                    </button>
                    {expanded && (
                        <div className="absolute bottom-12 right-0 w-96 max-h-96 overflow-auto bg-gray-900 text-green-400 p-3 rounded-lg text-xs font-mono">
                            <button onClick={() => { DEBUG_LOGS = []; setExpanded(false); }} className="text-red-400 mb-2">Clear</button>
                            {DEBUG_LOGS.slice(-20).reverse().map((log, i) => (
                                <div key={i} className="mb-2 border-b border-gray-700 pb-2">
                                    <div className="text-yellow-400">{log.label}</div>
                                    <pre className="whitespace-pre-wrap break-all">{JSON.stringify(log.data, null, 2)}</pre>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // =====================================================
        // MAIN APP COMPONENT
        // =====================================================
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [currentView, setCurrentView] = useState('scanner');
            const [selectedSession, setSelectedSession] = useState(null);
            const [showPasswordReset, setShowPasswordReset] = useState(false);
            const [isSiteAdmin, setIsSiteAdmin] = useState(false);
            const [, forceUpdate] = useState(0); // For debug panel refresh

            // Check for existing session on mount
            useEffect(() => {
                // Check URL for password recovery token BEFORE getting session
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const type = hashParams.get('type');
                
                if (type === 'recovery') {
                    setShowPasswordReset(true);
                }

                supabase.auth.getSession().then(async ({ data: { session } }) => {
                    setUser(session?.user || null);
                    
                    // Check if user is site_admin to enable debug mode
                    if (session?.user) {
                        const { data: teacher } = await supabase
                            .from('teachers')
                            .select('role')
                            .eq('teacher_id', session.user.id)
                            .single();
                        
                        if (teacher?.role === 'site_admin') {
                            DEBUG_MODE = true;
                            setIsSiteAdmin(true);
                            console.log('[DEBUG MODE ENABLED] You are a site_admin');
                        }
                    }
                    
                    setLoading(false);
                });

                const { data: { subscription } } = supabase.auth.onAuthStateChange(
                    (event, session) => {
                        console.log('Auth event:', event); // Debug log
                        setUser(session?.user || null);
                        
                        // Detect password recovery event
                        if (event === 'PASSWORD_RECOVERY') {
                            setShowPasswordReset(true);
                        }
                    }
                );

                return () => subscription.unsubscribe();
            }, []);

            const handleSignOut = async () => {
                await supabase.auth.signOut();
                setUser(null);
                setCurrentView('scanner');
            };

            const handleLoadSession = (cls) => {
                setSelectedSession(cls);
                setCurrentView('scanner');
            };

            const handlePasswordResetComplete = () => {
                setShowPasswordReset(false);
            };

            // Loading state
            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-brand-cream to-white flex items-center justify-center">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-brand-teal border-t-transparent"></div>
                            <p className="mt-4 text-gray-600">Loading...</p>
                        </div>
                    </div>
                );
            }

            // Password reset flow
            if (showPasswordReset && user) {
                return <PasswordResetScreen onComplete={handlePasswordResetComplete} />;
            }

            // Not authenticated
            if (!user) {
                return <AuthScreen onAuthSuccess={setUser} />;
            }

            // Main authenticated app (no API key needed anymore!)
            return (
                <div className="min-h-screen bg-gray-50">
                    <NavHeader
                        user={user}
                        onSignOut={handleSignOut}
                        currentView={currentView}
                        onViewChange={(view) => {
                            setCurrentView(view);
                            setSelectedSession(null);
                        }}
                        isSiteAdmin={isSiteAdmin}
                    />

                    {currentView === 'scanner' && (
                        <Scanner
                            user={user}
                            initialSession={selectedSession}
                        />
                    )}

                    {currentView === 'history' && (
                        <SessionHistory
                            user={user}
                            onLoadSession={handleLoadSession}
                        />
                    )}

                    {currentView === 'batches' && (
                        <BatchManagement user={user} />
                    )}
                    
                    <DebugPanel />
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
