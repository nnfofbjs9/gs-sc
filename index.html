<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gradesheet Scanner - Enrichment Express</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind config with brand colors
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            red: '#E63946',      // Primary red
                            teal: '#2A9D8F',     // Primary teal
                            'teal-dark': '#1E7268',
                            'red-dark': '#C1121F',
                            cream: '#FFF8F0',    // Light background
                            white: '#FFFFFF',
                        }
                    }
                }
            }
        }
    </script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // =====================================================
        // CONFIGURATION
        // =====================================================
        const SUPABASE_URL = 'https://zfkdypxmegocmjontbiz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpma2R5cHhtZWdvY21qb250Yml6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NzM3MDMsImV4cCI6MjA4MTU0OTcwM30.GLwItBWPKW4EZ67wiAPuaKq38DA5WfJ5UYcvPPYsWwI';
        
        // =====================================================
        // LOGO CONFIGURATION
        // =====================================================
        // >>> REPLACE THIS URL WITH YOUR COMPANY LOGO <<<
        // Upload your logo to Supabase Storage or use any public URL
        const COMPANY_LOGO_URL = '/logo.png';  // Place logo.png in your repo root, or use full URL like 'https://enrichmentexpress.com/assets/image/logo/1.png'
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // API endpoint (Vercel Edge Function)
        const API_ENDPOINT = '/api/openai';

        // =====================================================
        // DEBUG MODE (for site_admin role)
        // =====================================================
        let DEBUG_MODE = false;
        let DEBUG_LOGS = [];
        
        function debugLog(label, data) {
            if (DEBUG_MODE) {
                const entry = { time: new Date().toISOString(), label, data };
                DEBUG_LOGS.push(entry);
                console.log(`[DEBUG] ${label}:`, data);
            }
        }

        // =====================================================
        // API HELPER - Calls our Edge Function
        // =====================================================
        async function callOpenAI(action, data) {
            const session = await supabase.auth.getSession();
            const token = session?.data?.session?.access_token;

            if (!token) {
                throw new Error('Not authenticated');
            }

            debugLog('API Request', { action, dataKeys: Object.keys(data || {}) });

            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
                body: JSON.stringify({ action, data }),
            });

            const result = await response.json();
            
            debugLog('API Response', { status: response.status, result });

            if (!response.ok) {
                throw new Error(result.error || 'API request failed');
            }

            return result;
        }

        // =====================================================
        // AUTHENTICATION COMPONENT
        // =====================================================
        function AuthScreen({ onAuthSuccess }) {
            const [isLogin, setIsLogin] = useState(true);
            const [showForgotPassword, setShowForgotPassword] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setMessage('');
                setLoading(true);

                try {
                    if (isLogin) {
                        const { data, error } = await supabase.auth.signInWithPassword({
                            email,
                            password
                        });
                        if (error) throw error;
                        onAuthSuccess(data.user);
                    } else {
                        const { data, error } = await supabase.auth.signUp({
                            email,
                            password,
                            options: {
                                data: { name }
                            }
                        });
                        if (error) throw error;
                        
                        // Check if user already exists (Supabase returns a user with identities = [] for existing users)
                        if (data.user && data.user.identities && data.user.identities.length === 0) {
                            throw new Error('An account with this email already exists. Please sign in instead.');
                        }
                        
                        if (data.user && !data.session) {
                            setMessage('Check your email for the confirmation link!');
                        } else {
                            onAuthSuccess(data.user);
                        }
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleForgotPassword = async (e) => {
                e.preventDefault();
                setError('');
                setMessage('');
                
                if (!email.trim()) {
                    setError('Please enter your email address');
                    return;
                }
                
                setLoading(true);

                try {
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin,
                    });
                    if (error) throw error;
                    setMessage('Password reset link sent! Check your email.');
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-brand-cream to-white flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full border-t-4 border-brand-teal">
                        {/* LOGO - Replace COMPANY_LOGO_URL at top of file */}
                        <div className="flex justify-center mb-6">
                            <img src={COMPANY_LOGO_URL} alt="Company Logo" className="h-16 object-contain" onError={(e) => e.target.style.display='none'} />
                        </div>
                        <h1 className="text-3xl font-bold text-brand-teal mb-2 text-center">Gradesheet Scanner</h1>
                        <p className="text-gray-600 mb-6 text-center">
                            {showForgotPassword ? 'Reset your password' : (isLogin ? 'Sign in to continue' : 'Create your account')}
                        </p>

                        {error && (
                            <div className="bg-red-50 border border-brand-red text-brand-red px-4 py-3 rounded-lg mb-4">
                                {error}
                            </div>
                        )}

                        {message && (
                            <div className="bg-teal-50 border border-brand-teal text-brand-teal-dark px-4 py-3 rounded-lg mb-4">
                                {message}
                            </div>
                        )}

                        {showForgotPassword ? (
                            /* Forgot Password Form */
                            <form onSubmit={handleForgotPassword}>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Email Address
                                    </label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        placeholder="you@example.com"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent"
                                        required
                                    />
                                </div>

                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full bg-brand-teal text-white py-3 rounded-lg font-medium hover:bg-brand-teal-dark disabled:bg-gray-400 disabled:cursor-not-allowed transition"
                                >
                                    {loading ? 'Please wait...' : 'Send Reset Link'}
                                </button>

                                <div className="mt-4 text-center">
                                    <button
                                        type="button"
                                        onClick={() => {
                                            setShowForgotPassword(false);
                                            setError('');
                                            setMessage('');
                                        }}
                                        className="text-brand-teal hover:underline"
                                    >
                                        Back to Sign In
                                    </button>
                                </div>
                            </form>
                        ) : (
                            /* Login / Signup Form */
                            <form onSubmit={handleSubmit}>
                                {!isLogin && (
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Your Name
                                        </label>
                                        <input
                                            type="text"
                                            value={name}
                                            onChange={(e) => setName(e.target.value)}
                                            placeholder="Jane Smith"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent"
                                            required={!isLogin}
                                        />
                                    </div>
                                )}

                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Email Address
                                    </label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        placeholder="you@example.com"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent"
                                        required
                                    />
                                </div>

                                <div className="mb-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Password
                                    </label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        placeholder="••••••••"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent"
                                        required
                                        minLength={6}
                                    />
                                </div>

                                {isLogin && (
                                    <div className="mb-6 text-right">
                                        <button
                                            type="button"
                                            onClick={() => {
                                                setShowForgotPassword(true);
                                                setError('');
                                                setMessage('');
                                            }}
                                            className="text-sm text-brand-teal hover:underline"
                                        >
                                            Forgot password?
                                        </button>
                                    </div>
                                )}

                                {!isLogin && <div className="mb-6"></div>}

                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full bg-brand-teal text-white py-3 rounded-lg font-medium hover:bg-brand-teal-dark disabled:bg-gray-400 disabled:cursor-not-allowed transition"
                                >
                                    {loading ? 'Please wait...' : (isLogin ? 'Sign In' : 'Create Account')}
                                </button>
                            </form>
                        )}

                        {!showForgotPassword && (
                            <div className="mt-6 text-center">
                                <button
                                    onClick={() => {
                                        setIsLogin(!isLogin);
                                        setError('');
                                        setMessage('');
                                    }}
                                    className="text-brand-teal hover:underline"
                                >
                                    {isLogin ? "Don't have an account? Sign up" : 'Already have an account? Sign in'}
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // =====================================================
        // NAVIGATION HEADER COMPONENT
        // =====================================================
        function NavHeader({ user, onSignOut, currentView, onViewChange }) {
            const [showMenu, setShowMenu] = useState(false);

            return (
                <header className="bg-white shadow-sm border-b-2 border-brand-teal">
                    <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                        <div className="flex items-center gap-6">
                            {/* LOGO IN HEADER */}
                            <div className="flex items-center gap-3">
                                <img src={COMPANY_LOGO_URL} alt="Logo" className="h-10 object-contain" onError={(e) => e.target.style.display='none'} />
                                <h1 className="text-xl font-bold text-brand-teal">Gradesheet Scanner</h1>
                            </div>
                            <nav className="hidden md:flex gap-4">
                                <button
                                    onClick={() => onViewChange('scanner')}
                                    className={`px-3 py-1 rounded ${currentView === 'scanner' ? 'bg-teal-100 text-brand-teal' : 'text-gray-600 hover:text-gray-800'}`}
                                >
                                    Scanner
                                </button>
                                <button
                                    onClick={() => onViewChange('history')}
                                    className={`px-3 py-1 rounded ${currentView === 'history' ? 'bg-teal-100 text-brand-teal' : 'text-gray-600 hover:text-gray-800'}`}
                                >
                                    History
                                </button>
                                <button
                                    onClick={() => onViewChange('classes')}
                                    className={`px-3 py-1 rounded ${currentView === 'classes' ? 'bg-teal-100 text-brand-teal' : 'text-gray-600 hover:text-gray-800'}`}
                                >
                                    Classes
                                </button>
                            </nav>
                        </div>
                        
                        <div className="relative">
                            <button
                                onClick={() => setShowMenu(!showMenu)}
                                className="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100"
                            >
                                <div className="w-8 h-8 bg-brand-teal rounded-full flex items-center justify-center text-white font-medium">
                                    {user?.email?.[0]?.toUpperCase() || '?'}
                                </div>
                                <span className="hidden sm:inline text-gray-700">{user?.email}</span>
                            </button>

                            {showMenu && (
                                <div className="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50">
                                    <div className="md:hidden border-b border-gray-200 pb-1 mb-1">
                                        <button
                                            onClick={() => { onViewChange('scanner'); setShowMenu(false); }}
                                            className="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100"
                                        >
                                            Scanner
                                        </button>
                                        <button
                                            onClick={() => { onViewChange('history'); setShowMenu(false); }}
                                            className="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100"
                                        >
                                            History
                                        </button>
                                        <button
                                            onClick={() => { onViewChange('classes'); setShowMenu(false); }}
                                            className="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100"
                                        >
                                            Classes
                                        </button>
                                    </div>
                                    <button
                                        onClick={onSignOut}
                                        className="w-full text-left px-4 py-2 text-brand-red hover:bg-red-50"
                                    >
                                        Sign Out
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </header>
            );
        }

        // =====================================================
        // SESSION HISTORY COMPONENT
        // =====================================================
        function SessionHistory({ user, onLoadSession }) {
            const [sessions, setSessions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');

            useEffect(() => {
                loadSessions();
            }, []);

            const loadSessions = async () => {
                try {
                    const { data, error } = await supabase
                        .from('sessions')
                        .select(`
                            *,
                            classes (class_name, center_id),
                            reports (report_id, student_id)
                        `)
                        .eq('teacher_id', user.id)
                        .order('session_date', { ascending: false })
                        .limit(50);

                    if (error) throw error;
                    setSessions(data || []);
                } catch (err) {
                    setError('Failed to load sessions: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const deleteSession = async (sessionId) => {
                if (!confirm('Are you sure you want to delete this session? This will also delete all associated reports.')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('sessions')
                        .delete()
                        .eq('session_id', sessionId);

                    if (error) throw error;
                    setSessions(sessions.filter(s => s.session_id !== sessionId));
                } catch (err) {
                    setError('Failed to delete session: ' + err.message);
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-50 p-4">
                        <div className="max-w-4xl mx-auto pt-8 text-center">
                            <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-brand-teal border-t-transparent"></div>
                            <p className="mt-2 text-gray-600">Loading sessions...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-4xl mx-auto pt-4">
                        <div className="mb-6">
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">Session History</h2>
                            <p className="text-gray-600">View and manage your past grading sessions</p>
                        </div>

                        {error && (
                            <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-6">
                                {error}
                            </div>
                        )}

                        {sessions.length === 0 ? (
                            <div className="bg-white rounded-lg shadow p-8 text-center">
                                <p className="text-gray-600 mb-4">No sessions yet. Start by scanning a gradesheet!</p>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {sessions.map((session) => (
                                    <div key={session.session_id} className="bg-white rounded-lg shadow p-4">
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <h3 className="font-semibold text-gray-800">
                                                    {session.classes?.class_name || 'Unnamed Session'}
                                                </h3>
                                                <p className="text-sm text-gray-600">
                                                    {new Date(session.session_date).toLocaleDateString('en-GB', {
                                                        weekday: 'long',
                                                        year: 'numeric',
                                                        month: 'long',
                                                        day: 'numeric'
                                                    })}
                                                </p>
                                                <div className="mt-2 flex gap-2">
                                                    <span className={`px-2 py-1 text-xs rounded ${
                                                        session.status === 'sent' ? 'bg-green-100 text-green-700' :
                                                        session.status === 'completed' ? 'bg-teal-100 text-brand-teal' :
                                                        'bg-gray-100 text-gray-700'
                                                    }`}>
                                                        {session.status}
                                                    </span>
                                                    {session.reports && (
                                                        <span className="px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded">
                                                            {session.reports.length} reports
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => onLoadSession(session)}
                                                    className="px-3 py-1 text-sm bg-brand-teal text-white rounded hover:bg-brand-teal-dark"
                                                >
                                                    View
                                                </button>
                                                <button
                                                    onClick={() => deleteSession(session.session_id)}
                                                    className="px-3 py-1 text-sm text-red-600 border border-red-300 rounded hover:bg-red-50"
                                                >
                                                    Delete
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // =====================================================
        // CLASS MANAGEMENT COMPONENT
        // =====================================================
        function ClassManagement({ user }) {
            const [classes, setClasses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [showAddForm, setShowAddForm] = useState(false);
            const [newClassName, setNewClassName] = useState('');
            const [centers, setCenters] = useState([]);
            const [selectedCenter, setSelectedCenter] = useState('');

            useEffect(() => {
                loadData();
            }, []);

            const loadData = async () => {
                try {
                    // Load classes
                    const { data: classData, error: classError } = await supabase
                        .from('classes')
                        .select('*, centers(center_name), students(student_id, student_name)')
                        .eq('teacher_id', user.id)
                        .order('class_name');

                    if (classError) throw classError;
                    setClasses(classData || []);

                    // Load centers (for adding new classes)
                    const { data: centerData, error: centerError } = await supabase
                        .from('centers')
                        .select('*')
                        .eq('is_active', true);

                    if (centerError) throw centerError;
                    setCenters(centerData || []);
                    if (centerData?.length > 0) {
                        setSelectedCenter(centerData[0].center_id);
                    }
                } catch (err) {
                    setError('Failed to load data: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const addClass = async () => {
                if (!newClassName.trim() || !selectedCenter) return;

                try {
                    const { data, error } = await supabase
                        .from('classes')
                        .insert({
                            class_name: newClassName.trim(),
                            center_id: selectedCenter,
                            teacher_id: user.id
                        })
                        .select('*, centers(center_name)')
                        .single();

                    if (error) throw error;
                    setClasses([...classes, { ...data, students: [] }]);
                    setNewClassName('');
                    setShowAddForm(false);
                } catch (err) {
                    setError('Failed to add class: ' + err.message);
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-50 p-4">
                        <div className="max-w-4xl mx-auto pt-8 text-center">
                            <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-brand-teal border-t-transparent"></div>
                            <p className="mt-2 text-gray-600">Loading classes...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-4xl mx-auto pt-4">
                        <div className="mb-6 flex justify-between items-center">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">My Classes</h2>
                                <p className="text-gray-600">Manage your classes and students</p>
                            </div>
                            <button
                                onClick={() => setShowAddForm(true)}
                                className="px-4 py-2 bg-brand-teal text-white rounded-lg hover:bg-brand-teal-dark"
                            >
                                + Add Class
                            </button>
                        </div>

                        {error && (
                            <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-6">
                                {error}
                            </div>
                        )}

                        {showAddForm && (
                            <div className="bg-white rounded-lg shadow p-4 mb-6">
                                <h3 className="font-semibold text-gray-800 mb-3">Add New Class</h3>
                                <div className="flex gap-3">
                                    <input
                                        type="text"
                                        value={newClassName}
                                        onChange={(e) => setNewClassName(e.target.value)}
                                        placeholder="Class name"
                                        className="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-brand-teal"
                                    />
                                    {centers.length > 0 && (
                                        <select
                                            value={selectedCenter}
                                            onChange={(e) => setSelectedCenter(e.target.value)}
                                            className="px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-brand-teal"
                                        >
                                            {centers.map(c => (
                                                <option key={c.center_id} value={c.center_id}>
                                                    {c.center_name}
                                                </option>
                                            ))}
                                        </select>
                                    )}
                                    <button
                                        onClick={addClass}
                                        className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                                    >
                                        Add
                                    </button>
                                    <button
                                        onClick={() => setShowAddForm(false)}
                                        className="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-100"
                                    >
                                        Cancel
                                    </button>
                                </div>
                                {centers.length === 0 && (
                                    <p className="mt-2 text-sm text-amber-600">
                                        Note: No centers found. Please ask an admin to add you to a center.
                                    </p>
                                )}
                            </div>
                        )}

                        {classes.length === 0 ? (
                            <div className="bg-white rounded-lg shadow p-8 text-center">
                                <p className="text-gray-600 mb-4">No classes yet. Add your first class to get started!</p>
                            </div>
                        ) : (
                            <div className="grid gap-4 md:grid-cols-2">
                                {classes.map((cls) => (
                                    <div key={cls.class_id} className="bg-white rounded-lg shadow p-4">
                                        <h3 className="font-semibold text-gray-800">{cls.class_name}</h3>
                                        <p className="text-sm text-gray-600">{cls.centers?.center_name}</p>
                                        <div className="mt-2">
                                            <span className="px-2 py-1 text-xs bg-teal-100 text-brand-teal rounded">
                                                {cls.students?.length || 0} students
                                            </span>
                                            {cls.level && (
                                                <span className="ml-2 px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded">
                                                    Level {cls.level}
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // =====================================================
        // MAIN SCANNER COMPONENT
        // =====================================================
        function Scanner({ user, initialSession }) {
            const [currentScreen, setCurrentScreen] = useState(initialSession ? 'edit' : 'upload');
            const [uploadedImage, setUploadedImage] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [activities, setActivities] = useState(initialSession?.ocr_processed?.activities || []);
            const [students, setStudents] = useState(initialSession?.ocr_processed?.students || []);
            const [reports, setReports] = useState([]);
            const [error, setError] = useState('');
            const [currentSessionId, setCurrentSessionId] = useState(initialSession?.session_id || null);
            const [selectedClassId, setSelectedClassId] = useState(initialSession?.class_id || null);
            const [classes, setClasses] = useState([]);
            const [saveStatus, setSaveStatus] = useState('');

            // Load teacher's classes on mount
            useEffect(() => {
                loadClasses();
            }, []);

            // Load existing reports if viewing a session
            useEffect(() => {
                if (initialSession?.session_id) {
                    loadSessionReports(initialSession.session_id);
                }
            }, [initialSession]);

            const loadClasses = async () => {
                const { data, error } = await supabase
                    .from('classes')
                    .select('class_id, class_name')
                    .eq('teacher_id', user.id)
                    .eq('is_active', true);

                if (!error && data) {
                    setClasses(data);
                    if (data.length > 0 && !selectedClassId) {
                        setSelectedClassId(data[0].class_id);
                    }
                }
            };

            const loadSessionReports = async (sessionId) => {
                const { data, error } = await supabase
                    .from('reports')
                    .select('*, students(student_name)')
                    .eq('session_id', sessionId);

                if (!error && data && data.length > 0) {
                    setReports(data.map(r => ({
                        studentName: r.students?.student_name || 'Unknown',
                        report: r.report_body
                    })));
                    setCurrentScreen('reports');
                }
            };

            // Compress image before upload
            const compressImage = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            
                            const maxDim = 1024;
                            if (width > maxDim || height > maxDim) {
                                if (width > height) {
                                    height = (height / width) * maxDim;
                                    width = maxDim;
                                } else {
                                    width = (width / height) * maxDim;
                                    height = maxDim;
                                }
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.8));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };

            // Save session to database
            const saveSession = async (ocrData, imageBase64) => {
                try {
                    setSaveStatus('Saving...');
                    
                    const sessionData = {
                        class_id: selectedClassId,
                        teacher_id: user.id,
                        session_date: new Date().toISOString().split('T')[0],
                        ocr_raw: ocrData,
                        ocr_processed: ocrData,
                        status: 'draft'
                    };

                    let sessionId = currentSessionId;

                    if (currentSessionId) {
                        const { error } = await supabase
                            .from('sessions')
                            .update(sessionData)
                            .eq('session_id', currentSessionId);
                        if (error) throw error;
                    } else {
                        const { data, error } = await supabase
                            .from('sessions')
                            .insert(sessionData)
                            .select()
                            .single();
                        
                        if (error) throw error;
                        sessionId = data.session_id;
                        setCurrentSessionId(sessionId);
                    }

                    // Upload image to storage
                    if (imageBase64 && sessionId) {
                        try {
                            const base64Data = imageBase64.split(',')[1];
                            const byteCharacters = atob(base64Data);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            const blob = new Blob([byteArray], { type: 'image/jpeg' });

                            const filePath = `${user.id}/${sessionId}.jpg`;
                            const { error: uploadError } = await supabase.storage
                                .from('gradesheets')
                                .upload(filePath, blob, { upsert: true });

                            if (!uploadError) {
                                const { data: urlData } = supabase.storage
                                    .from('gradesheets')
                                    .getPublicUrl(filePath);

                                await supabase
                                    .from('sessions')
                                    .update({ scan_file_url: urlData.publicUrl })
                                    .eq('session_id', sessionId);
                            }
                        } catch (uploadErr) {
                            console.warn('Image upload failed (non-critical):', uploadErr);
                        }
                    }

                    setSaveStatus('Saved!');
                    setTimeout(() => setSaveStatus(''), 2000);
                    return sessionId;
                } catch (err) {
                    console.error('Save error:', err);
                    setSaveStatus('Save failed');
                    return null;
                }
            };

            // Handle image upload
            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setError('');
                setIsProcessing(true);

                try {
                    const compressedImage = await compressImage(file);
                    setUploadedImage(compressedImage);

                    const base64Image = compressedImage.split(',')[1];
                    
                    // Call our Edge Function instead of OpenAI directly
                    const data = await callOpenAI('extract', { image: base64Image });

                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        throw new Error('Could not read the image. Please upload a clearer photo of the gradesheet.');
                    }

                    let extractedText = data.choices[0].message.content.trim();
                    extractedText = extractedText.replace(/```json\n?/g, '').replace(/```\n?/g, '');
                    
                    let extractedData;
                    try {
                        extractedData = JSON.parse(extractedText);
                    } catch (parseErr) {
                        throw new Error('Could not extract data from this image. Please upload a clearer photo with visible student names and grades.');
                    }
                    
                    if (!extractedData.activities || !extractedData.students || extractedData.students.length === 0) {
                        throw new Error('No student data found in the image. Please ensure the gradesheet is clearly visible.');
                    }

                    setActivities(extractedData.activities);
                    setStudents(extractedData.students);
                    setCurrentScreen('edit');

                    // Auto-save to database
                    await saveSession(extractedData, compressedImage);
                } catch (err) {
                    setError(`Error: ${err.message}`);
                    console.error(err);
                } finally {
                    setIsProcessing(false);
                }
            };

            // Update functions
            const updateGrade = (studentIndex, activityIndex, value) => {
                const updated = [...students];
                updated[studentIndex].grades[activityIndex] = value;
                setStudents(updated);
            };

            const updateStudentName = (index, value) => {
                const updated = [...students];
                updated[index].name = value;
                setStudents(updated);
            };

            const updateActivityName = (index, value) => {
                const updated = [...activities];
                updated[index] = value;
                setActivities(updated);
            };

            const addStudent = () => {
                setStudents([...students, { 
                    name: '', 
                    grades: new Array(activities.length).fill('') 
                }]);
            };

            const deleteStudent = (index) => {
                setStudents(students.filter((_, i) => i !== index));
            };

            const addActivity = () => {
                setActivities([...activities, '']);
                const updated = students.map(student => ({
                    ...student,
                    grades: [...student.grades, '']
                }));
                setStudents(updated);
            };

            const deleteActivity = (index) => {
                setActivities(activities.filter((_, i) => i !== index));
                const updated = students.map(student => ({
                    ...student,
                    grades: student.grades.filter((_, i) => i !== index)
                }));
                setStudents(updated);
            };

            // Save reports to database
            const saveReports = async (sessionId, generatedReports) => {
                if (!sessionId) return;

                try {
                    await supabase
                        .from('reports')
                        .delete()
                        .eq('session_id', sessionId);

                    const reportRecords = generatedReports.map(r => ({
                        session_id: sessionId,
                        student_id: null,
                        report_body: r.report,
                        generated_by: user.id
                    }));

                    await supabase.from('reports').insert(reportRecords);

                    await supabase
                        .from('sessions')
                        .update({ status: 'completed' })
                        .eq('session_id', sessionId);
                } catch (err) {
                    console.error('Failed to save reports:', err);
                }
            };

            // Generate reports
            const generateReports = async () => {
                setError('');
                setIsProcessing(true);
                const generatedReports = [];

                try {
                    const sessionId = await saveSession(
                        { activities, students },
                        uploadedImage
                    );

                    for (const student of students) {
                        const activityGrades = activities.map((activity, idx) => 
                            `${activity}: ${student.grades[idx] || 'Not graded'}`
                        ).join('\n');

                        // Call our Edge Function instead of OpenAI directly
                        const data = await callOpenAI('generate_report', {
                            studentName: student.name,
                            activityGrades: activityGrades
                        });

                        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                            throw new Error(`Failed to generate report for ${student.name}. Please try again.`);
                        }

                        generatedReports.push({
                            studentName: student.name,
                            report: data.choices[0].message.content.trim()
                        });
                    }

                    setReports(generatedReports);
                    setCurrentScreen('reports');

                    await saveReports(sessionId, generatedReports);
                } catch (err) {
                    setError(`Error generating reports: ${err.message}`);
                    console.error(err);
                } finally {
                    setIsProcessing(false);
                }
            };

            // Download report
            const downloadReport = (studentName, report) => {
                const element = document.createElement('a');
                const file = new Blob([`Report for ${studentName}\n\n${report}`], {type: 'text/plain'});
                element.href = URL.createObjectURL(file);
                element.download = `${studentName.replace(/\s+/g, '_')}_report.txt`;
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            };

            // Download all reports
            const downloadAllReports = () => {
                const allContent = reports.map(r => 
                    `${'='.repeat(50)}\nReport for ${r.studentName}\n${'='.repeat(50)}\n\n${r.report}\n\n`
                ).join('\n');
                
                const element = document.createElement('a');
                const file = new Blob([allContent], {type: 'text/plain'});
                element.href = URL.createObjectURL(file);
                element.download = `all_reports_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            };

            // Upload Screen
            if (currentScreen === 'upload') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-brand-cream to-white p-4">
                        <div className="max-w-2xl mx-auto pt-8">
                            <h2 className="text-3xl font-bold text-gray-800 mb-2 text-center">Scan Gradesheet</h2>
                            <p className="text-gray-600 mb-8 text-center">Upload or photograph a gradesheet to extract data</p>

                            {classes.length > 0 && (
                                <div className="mb-6">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Select Class
                                    </label>
                                    <select
                                        value={selectedClassId || ''}
                                        onChange={(e) => setSelectedClassId(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal"
                                    >
                                        <option value="">-- No class selected --</option>
                                        {classes.map(c => (
                                            <option key={c.class_id} value={c.class_id}>
                                                {c.class_name}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            )}

                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-6">
                                    {error}
                                </div>
                            )}

                            <div className="bg-white rounded-lg shadow-lg p-8">
                                <label className="flex flex-col items-center justify-center w-full h-64 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                                    <div className="flex flex-col items-center justify-center pt-5 pb-6">
                                        <svg className="w-16 h-16 mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                        </svg>
                                        <p className="mb-2 text-lg font-medium text-gray-700">
                                            {isProcessing ? 'Processing...' : 'Click to upload or take photo'}
                                        </p>
                                        <p className="text-sm text-gray-500">JPG, PNG, or JPEG</p>
                                    </div>
                                    <input
                                        type="file"
                                        accept="image/*"
                                        capture="environment"
                                        onChange={handleImageUpload}
                                        disabled={isProcessing}
                                        className="hidden"
                                    />
                                </label>

                                {isProcessing && (
                                    <div className="mt-6 text-center">
                                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-brand-teal border-t-transparent"></div>
                                        <p className="mt-2 text-gray-600">Extracting student data...</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // Edit Grid Screen
            if (currentScreen === 'edit') {
                return (
                    <div className="min-h-screen bg-gray-50 p-4">
                        <div className="max-w-7xl mx-auto pt-4">
                            <div className="mb-6 flex justify-between items-center">
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-800 mb-1">Review & Edit Data</h2>
                                    <p className="text-gray-600">Make any necessary corrections before generating reports</p>
                                </div>
                                {saveStatus && (
                                    <span className={`px-3 py-1 rounded text-sm ${
                                        saveStatus === 'Saved!' ? 'bg-green-100 text-green-700' : 
                                        saveStatus === 'Save failed' ? 'bg-red-100 text-red-700' : 
                                        'bg-gray-100 text-gray-700'
                                    }`}>
                                        {saveStatus}
                                    </span>
                                )}
                            </div>

                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-6">
                                    {error}
                                </div>
                            )}

                            <div className="bg-white rounded-lg shadow overflow-x-auto">
                                <table className="w-full border-collapse">
                                    <thead className="bg-gray-100 border-b-2 border-gray-300">
                                        <tr>
                                            <th className="px-3 py-3 text-left text-sm font-semibold text-gray-700 border-r-2 border-gray-300 sticky left-0 bg-gray-100">
                                                Student Name
                                            </th>
                                            {activities.map((activity, index) => (
                                                <th key={index} className="px-3 py-3 text-center text-sm font-semibold text-gray-700 min-w-[140px]">
                                                    <input
                                                        type="text"
                                                        value={activity}
                                                        onChange={(e) => updateActivityName(index, e.target.value)}
                                                        className="w-full px-2 py-1 border border-gray-300 rounded text-center focus:ring-2 focus:ring-brand-teal"
                                                    />
                                                    <button
                                                        onClick={() => deleteActivity(index)}
                                                        className="mt-1 text-xs text-red-600 hover:text-red-800"
                                                    >
                                                        Delete
                                                    </button>
                                                </th>
                                            ))}
                                            <th className="px-3 py-3 text-center text-sm font-semibold text-gray-700">
                                                <button
                                                    onClick={addActivity}
                                                    className="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                                                >
                                                    + Activity
                                                </button>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {students.map((student, studentIndex) => (
                                            <tr key={studentIndex} className="border-b hover:bg-gray-50">
                                                <td className="px-3 py-3 border-r-2 border-gray-300 sticky left-0 bg-white">
                                                    <input
                                                        type="text"
                                                        value={student.name}
                                                        onChange={(e) => updateStudentName(studentIndex, e.target.value)}
                                                        className="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-brand-teal"
                                                        placeholder="Student name"
                                                    />
                                                </td>
                                                {student.grades.map((grade, gradeIndex) => (
                                                    <td key={gradeIndex} className="px-3 py-3 text-center">
                                                        <select
                                                            value={grade}
                                                            onChange={(e) => updateGrade(studentIndex, gradeIndex, e.target.value)}
                                                            className="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-brand-teal text-center"
                                                        >
                                                            <option value="">-</option>
                                                            <option value="A">A (Excellent)</option>
                                                            <option value="B">B (Good)</option>
                                                            <option value="C">C (Needs Practice)</option>
                                                            <option value="X">X (Absent)</option>
                                                        </select>
                                                    </td>
                                                ))}
                                                <td className="px-3 py-3 text-center">
                                                    <button
                                                        onClick={() => deleteStudent(studentIndex)}
                                                        className="text-red-600 hover:text-red-800 font-medium text-sm"
                                                    >
                                                        Delete
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            <div className="mt-6 flex gap-4 flex-wrap">
                                <button
                                    onClick={addStudent}
                                    className="px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition"
                                >
                                    + Add Student
                                </button>
                                <button
                                    onClick={async () => {
                                        await saveSession({ activities, students }, uploadedImage);
                                    }}
                                    className="px-6 py-3 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700 transition"
                                >
                                    Save Draft
                                </button>
                                <button
                                    onClick={() => {
                                        setCurrentScreen('upload');
                                        setStudents([]);
                                        setActivities([]);
                                        setUploadedImage(null);
                                        setCurrentSessionId(null);
                                    }}
                                    className="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition"
                                >
                                    Start Over
                                </button>
                                <button
                                    onClick={generateReports}
                                    disabled={isProcessing || students.length === 0 || students.some(s => !s.name.trim())}
                                    className="ml-auto px-8 py-3 bg-brand-teal text-white rounded-lg font-medium hover:bg-brand-teal-dark disabled:bg-gray-400 disabled:cursor-not-allowed transition"
                                >
                                    {isProcessing ? 'Generating...' : 'Generate Reports'}
                                </button>
                            </div>

                            {isProcessing && (
                                <div className="mt-6 text-center">
                                    <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-brand-teal border-t-transparent"></div>
                                    <p className="mt-2 text-gray-600">Creating personalized reports...</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // Reports Screen
            if (currentScreen === 'reports') {
                return (
                    <div className="min-h-screen bg-gray-50 p-4">
                        <div className="max-w-4xl mx-auto pt-4">
                            <div className="mb-6">
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">Generated Reports</h2>
                                <p className="text-gray-600">Review and download individual student reports</p>
                            </div>

                            <div className="mb-4">
                                <button
                                    onClick={downloadAllReports}
                                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
                                >
                                    Download All Reports
                                </button>
                            </div>

                            <div className="space-y-4">
                                {reports.map((report, index) => (
                                    <div key={index} className="bg-white rounded-lg shadow p-6">
                                        <div className="flex justify-between items-start mb-3">
                                            <h3 className="text-xl font-semibold text-gray-800">{report.studentName}</h3>
                                            <button
                                                onClick={() => downloadReport(report.studentName, report.report)}
                                                className="px-4 py-2 bg-brand-teal text-white text-sm rounded hover:bg-brand-teal-dark transition"
                                            >
                                                Download
                                            </button>
                                        </div>
                                        <div className="text-gray-700 leading-relaxed whitespace-pre-wrap">{report.report}</div>
                                    </div>
                                ))}
                            </div>

                            <div className="mt-8 flex gap-4">
                                <button
                                    onClick={() => {
                                        setCurrentScreen('upload');
                                        setStudents([]);
                                        setActivities([]);
                                        setReports([]);
                                        setUploadedImage(null);
                                        setCurrentSessionId(null);
                                    }}
                                    className="px-6 py-3 bg-brand-teal text-white rounded-lg font-medium hover:bg-brand-teal-dark transition"
                                >
                                    Process Another Gradesheet
                                </button>
                                <button
                                    onClick={() => setCurrentScreen('edit')}
                                    className="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition"
                                >
                                    Back to Edit
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        }

        // =====================================================
        // PASSWORD RESET COMPONENT
        // =====================================================
        function PasswordResetScreen({ onComplete }) {
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setMessage('');

                if (newPassword !== confirmPassword) {
                    setError('Passwords do not match');
                    return;
                }

                if (newPassword.length < 6) {
                    setError('Password must be at least 6 characters');
                    return;
                }

                setLoading(true);

                try {
                    const { error } = await supabase.auth.updateUser({
                        password: newPassword
                    });

                    if (error) throw error;

                    setMessage('Password updated successfully!');
                    
                    // Clear the URL hash so refresh doesn't show reset screen again
                    window.history.replaceState(null, '', window.location.pathname);
                    
                    setTimeout(() => {
                        onComplete();
                    }, 1500);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-brand-cream to-white flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                        <h1 className="text-3xl font-bold text-gray-800 mb-2">Reset Password</h1>
                        <p className="text-gray-600 mb-6">Enter your new password</p>

                        {error && (
                            <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-4">
                                {error}
                            </div>
                        )}

                        {message && (
                            <div className="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg mb-4">
                                {message}
                            </div>
                        )}

                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    New Password
                                </label>
                                <input
                                    type="password"
                                    value={newPassword}
                                    onChange={(e) => setNewPassword(e.target.value)}
                                    placeholder="••••••••"
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent"
                                    required
                                    minLength={6}
                                />
                            </div>

                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Confirm New Password
                                </label>
                                <input
                                    type="password"
                                    value={confirmPassword}
                                    onChange={(e) => setConfirmPassword(e.target.value)}
                                    placeholder="••••••••"
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent"
                                    required
                                    minLength={6}
                                />
                            </div>

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-brand-teal text-white py-3 rounded-lg font-medium hover:bg-brand-teal-dark disabled:bg-gray-400 disabled:cursor-not-allowed transition"
                            >
                                {loading ? 'Updating...' : 'Update Password'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // =====================================================
        // DEBUG PANEL COMPONENT (for site_admin)
        // =====================================================
        function DebugPanel() {
            const [expanded, setExpanded] = useState(false);
            
            if (!DEBUG_MODE) return null;
            
            return (
                <div className="fixed bottom-4 right-4 z-50">
                    <button 
                        onClick={() => setExpanded(!expanded)}
                        className="bg-gray-800 text-white px-3 py-2 rounded-lg text-sm"
                    >
                        🐛 Debug ({DEBUG_LOGS.length})
                    </button>
                    {expanded && (
                        <div className="absolute bottom-12 right-0 w-96 max-h-96 overflow-auto bg-gray-900 text-green-400 p-3 rounded-lg text-xs font-mono">
                            <button onClick={() => { DEBUG_LOGS = []; setExpanded(false); }} className="text-red-400 mb-2">Clear</button>
                            {DEBUG_LOGS.slice(-20).reverse().map((log, i) => (
                                <div key={i} className="mb-2 border-b border-gray-700 pb-2">
                                    <div className="text-yellow-400">{log.label}</div>
                                    <pre className="whitespace-pre-wrap break-all">{JSON.stringify(log.data, null, 2)}</pre>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // =====================================================
        // MAIN APP COMPONENT
        // =====================================================
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [currentView, setCurrentView] = useState('scanner');
            const [selectedSession, setSelectedSession] = useState(null);
            const [showPasswordReset, setShowPasswordReset] = useState(false);
            const [, forceUpdate] = useState(0); // For debug panel refresh

            // Check for existing session on mount
            useEffect(() => {
                // Check URL for password recovery token BEFORE getting session
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const type = hashParams.get('type');
                
                if (type === 'recovery') {
                    setShowPasswordReset(true);
                }

                supabase.auth.getSession().then(async ({ data: { session } }) => {
                    setUser(session?.user || null);
                    
                    // Check if user is site_admin to enable debug mode
                    if (session?.user) {
                        const { data: teacher } = await supabase
                            .from('teachers')
                            .select('role')
                            .eq('teacher_id', session.user.id)
                            .single();
                        
                        if (teacher?.role === 'site_admin') {
                            DEBUG_MODE = true;
                            console.log('[DEBUG MODE ENABLED] You are a site_admin');
                        }
                    }
                    
                    setLoading(false);
                });

                const { data: { subscription } } = supabase.auth.onAuthStateChange(
                    (event, session) => {
                        console.log('Auth event:', event); // Debug log
                        setUser(session?.user || null);
                        
                        // Detect password recovery event
                        if (event === 'PASSWORD_RECOVERY') {
                            setShowPasswordReset(true);
                        }
                    }
                );

                return () => subscription.unsubscribe();
            }, []);

            const handleSignOut = async () => {
                await supabase.auth.signOut();
                setUser(null);
                setCurrentView('scanner');
            };

            const handleLoadSession = (session) => {
                setSelectedSession(session);
                setCurrentView('scanner');
            };

            const handlePasswordResetComplete = () => {
                setShowPasswordReset(false);
            };

            // Loading state
            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-brand-cream to-white flex items-center justify-center">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-brand-teal border-t-transparent"></div>
                            <p className="mt-4 text-gray-600">Loading...</p>
                        </div>
                    </div>
                );
            }

            // Password reset flow
            if (showPasswordReset && user) {
                return <PasswordResetScreen onComplete={handlePasswordResetComplete} />;
            }

            // Not authenticated
            if (!user) {
                return <AuthScreen onAuthSuccess={setUser} />;
            }

            // Main authenticated app (no API key needed anymore!)
            return (
                <div className="min-h-screen bg-gray-50">
                    <NavHeader 
                        user={user} 
                        onSignOut={handleSignOut}
                        currentView={currentView}
                        onViewChange={(view) => {
                            setCurrentView(view);
                            setSelectedSession(null);
                        }}
                    />

                    {currentView === 'scanner' && (
                        <Scanner 
                            user={user} 
                            initialSession={selectedSession}
                        />
                    )}

                    {currentView === 'history' && (
                        <SessionHistory 
                            user={user}
                            onLoadSession={handleLoadSession}
                        />
                    )}

                    {currentView === 'classes' && (
                        <ClassManagement user={user} />
                    )}
                    
                    <DebugPanel />
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
