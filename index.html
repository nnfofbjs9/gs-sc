<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gradesheet Scanner</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const SYSTEM_PROMPT = `You are an AI teaching assistant for a preschool enrichment program. You analyze teacher-provided skill ratings for each child and generate friendly, parent-facing feedback and short home activities using the PlayPack – a box of educational toys. There are 4 ratings: Excellent, Good, Needs Practice and Absent for class (abbreviated A, B, C and X, respectively). Keep the tone warm, supportive, and encouraging. Prioritize educational tasks for those fields in which the child has done poorly, but also those where they have done very well – thus encouraging them in easy tasks while getting them to improve in weak areas.
The kit contains the following elements beads, playdoh, number tiles (dominos with numbers on them but without dots). Don't require much extra work from the parent even as little as asking them to draw something.
Be very careful that the activities are completely safe for children. None of the activities should involve putting anything in the mouth, climbing or putting oneself or others in danger in anyway.
For each child, generate:
1. A 3–4 line summary in friendly tone.
2. 3-4 fun, 15-minute home activities.
Keep total reply per child under 200 words.
Very important: The response must not contain m-dashes ("—"). Replace them with colons where appropriate.

Writing style:
Do not use m-dashes ("—")
Use clear, direct language and avoid complex terminology.
Use British English spellings
Aim for a Flesch reading score of 80 or higher.
Use the active voice.
Avoid adverbs.
Avoid buzzwords and instead use plain English.
Use jargon where relevant.
Avoid being salesy or overly enthusiastic and instead express calm confidence.`;

        function App() {
            const [apiKey, setApiKey] = useState(import.meta.env.VITE_OPENAI_API_KEY || '');
            const [showApiInput, setShowApiInput] = useState(!import.meta.env.VITE_OPENAI_API_KEY);
            const [currentScreen, setCurrentScreen] = useState('upload'); // upload, edit, reports
            const [uploadedImage, setUploadedImage] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [activities, setActivities] = useState([]);
            const [students, setStudents] = useState([]);
            const [reports, setReports] = useState([]);
            const [error, setError] = useState('');

            // Compress image before upload
            const compressImage = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            
                            // Limit max dimension to 1024px
                            const maxDim = 1024;
                            if (width > maxDim || height > maxDim) {
                                if (width > height) {
                                    height = (height / width) * maxDim;
                                    width = maxDim;
                                } else {
                                    width = (width / height) * maxDim;
                                    height = maxDim;
                                }
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.8));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };

            // Handle image upload
            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setError('');
                setIsProcessing(true);

                try {
                    // Compress image
                    const compressedImage = await compressImage(file);
                    setUploadedImage(compressedImage);

                    // Extract data using GPT Vision
                    const base64Image = compressedImage.split(',')[1];
                    
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-5-mini',
                            messages: [
                                {
                                    role: 'user',
                                    content: [
                                        {
                                            type: 'text',
                                            text: 'Extract student gradesheet data from this image. The gradesheet should show students in rows and activities/assessments in columns. Return ONLY a JSON object with this exact format: {"activities": ["Activity 1", "Activity 2", ...], "students": [{"name": "Student Name", "grades": ["A", "B", "C", ...]}, ...]}. The grades array should match the activities array in order. Use "A" for Excellent, "B" for Good, "C" for Needs Practice, "X" for Absent. If a grade is unclear, use empty string "".'
                                        },
                                        {
                                            type: 'image_url',
                                            image_url: {
                                                url: `data:image/jpeg;base64,${base64Image}`
                                            }
                                        }
                                    ]
                                }
                            ],
                            max_completion_tokens: 1500
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message);
                    }

                    // Parse the response
                    let extractedText = data.choices[0].message.content.trim();
                    
                    // Remove markdown code blocks if present
                    extractedText = extractedText.replace(/```json\n?/g, '').replace(/```\n?/g, '');
                    
                    const extractedData = JSON.parse(extractedText);
                    
                    if (!extractedData.activities || !extractedData.students || extractedData.students.length === 0) {
                        throw new Error('No student data found in the image');
                    }

                    setActivities(extractedData.activities);
                    setStudents(extractedData.students);
                    setCurrentScreen('edit');
                } catch (err) {
                    setError(`Error: ${err.message}. Please check your API key and try again.`);
                    console.error(err);
                } finally {
                    setIsProcessing(false);
                }
            };

            // Update student grade
            const updateGrade = (studentIndex, activityIndex, value) => {
                const updated = [...students];
                updated[studentIndex].grades[activityIndex] = value;
                setStudents(updated);
            };

            // Update student name
            const updateStudentName = (index, value) => {
                const updated = [...students];
                updated[index].name = value;
                setStudents(updated);
            };

            // Update activity name
            const updateActivityName = (index, value) => {
                const updated = [...activities];
                updated[index] = value;
                setActivities(updated);
            };

            // Add new student row
            const addStudent = () => {
                setStudents([...students, { 
                    name: '', 
                    grades: new Array(activities.length).fill('') 
                }]);
            };

            // Delete student row
            const deleteStudent = (index) => {
                setStudents(students.filter((_, i) => i !== index));
            };

            // Add new activity column
            const addActivity = () => {
                setActivities([...activities, '']);
                // Add empty grade for this activity to all students
                const updated = students.map(student => ({
                    ...student,
                    grades: [...student.grades, '']
                }));
                setStudents(updated);
            };

            // Delete activity column
            const deleteActivity = (index) => {
                setActivities(activities.filter((_, i) => i !== index));
                // Remove this grade from all students
                const updated = students.map(student => ({
                    ...student,
                    grades: student.grades.filter((_, i) => i !== index)
                }));
                setStudents(updated);
            };

            // Generate reports using gpt-4o-mini with prompt caching
            const generateReports = async () => {
                setError('');
                setIsProcessing(true);
                const generatedReports = [];

                try {
                    for (const student of students) {
                        // Build activity-grade pairs
                        const activityGrades = activities.map((activity, idx) => 
                            `${activity}: ${student.grades[idx] || 'Not graded'}`
                        ).join('\n');

                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                model: 'gpt-5-mini',
                                messages: [
                                    {
                                        role: 'system',
                                        content: [
                                            {
                                                type: 'text',
                                                text: SYSTEM_PROMPT,
                                                cache_control: { type: 'ephemeral' }
                                            }
                                        ]
                                    },
                                    {
                                        role: 'user',
                                        content: `Child: ${student.name}\n\nActivity Ratings:\n${activityGrades}\n\nFor each child, generate:
1. A 3-4 line summary in friendly tone.
2. 3-4 fun, 15-minute home activities.
Keep total reply under 200 words.
Very important: The response must not contain m-dashes (“—”)
.`
                                    }
                                ],
                                max_completion_tokens: 400
                            })
                        });

                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error.message);
                        }

                        generatedReports.push({
                            studentName: student.name,
                            report: data.choices[0].message.content.trim()
                        });
                    }

                    setReports(generatedReports);
                    setCurrentScreen('reports');
                } catch (err) {
                    setError(`Error generating reports: ${err.message}`);
                    console.error(err);
                } finally {
                    setIsProcessing(false);
                }
            };

            // Download report as text file
            const downloadReport = (studentName, report) => {
                const element = document.createElement('a');
                const file = new Blob([`Report for ${studentName}\n\n${report}`], {type: 'text/plain'});
                element.href = URL.createObjectURL(file);
                element.download = `${studentName.replace(/\s+/g, '_')}_report.txt`;
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            };

            // API Key Setup Screen
            if (showApiInput) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                            <h1 className="text-3xl font-bold text-gray-800 mb-2">Gradesheet Scanner</h1>
                            <p className="text-gray-600 mb-6">Enter your OpenAI API key to get started</p>
                            
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    OpenAI API Key
                                </label>
                                <input
                                    type="password"
                                    value={apiKey}
                                    onChange={(e) => setApiKey(e.target.value)}
                                    placeholder="sk-..."
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                            </div>

                            <button
                                onClick={() => {
                                    if (apiKey.trim()) {
                                        setShowApiInput(false);
                                    } else {
                                        setError('Please enter your API key');
                                    }
                                }}
                                disabled={!apiKey.trim()}
                                className="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition"
                            >
                                Continue
                            </button>

                            <div className="mt-4 p-4 bg-blue-50 rounded-lg text-sm text-gray-700">
                                <p className="font-medium mb-1">Don't have an API key?</p>
                                <p>Get one at <a href="https://platform.openai.com/api-keys" target="_blank" className="text-blue-600 underline">platform.openai.com/api-keys</a></p>
                            </div>
                        </div>
                    </div>
                );
            }

            // Upload Screen
            if (currentScreen === 'upload') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                        <div className="max-w-2xl mx-auto pt-8">
                            <h1 className="text-4xl font-bold text-gray-800 mb-2 text-center">Gradesheet Scanner</h1>
                            <p className="text-gray-600 mb-8 text-center">Upload a gradesheet to get started</p>

                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-6">
                                    {error}
                                </div>
                            )}

                            <div className="bg-white rounded-lg shadow-lg p-8">
                                <label className="flex flex-col items-center justify-center w-full h-64 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                                    <div className="flex flex-col items-center justify-center pt-5 pb-6">
                                        <svg className="w-16 h-16 mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                        </svg>
                                        <p className="mb-2 text-lg font-medium text-gray-700">
                                            {isProcessing ? 'Processing...' : 'Click to upload or take photo'}
                                        </p>
                                        <p className="text-sm text-gray-500">JPG, PNG, or JPEG</p>
                                    </div>
                                    <input
                                        type="file"
                                        accept="image/*"
                                        capture="environment"
                                        onChange={handleImageUpload}
                                        disabled={isProcessing}
                                        className="hidden"
                                    />
                                </label>

                                {isProcessing && (
                                    <div className="mt-6 text-center">
                                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-600 border-t-transparent"></div>
                                        <p className="mt-2 text-gray-600">Extracting student data...</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // Edit Grid Screen
            if (currentScreen === 'edit') {
                return (
                    <div className="min-h-screen bg-gray-50 p-4">
                        <div className="max-w-7xl mx-auto pt-4">
                            <div className="mb-6">
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">Review & Edit Data</h1>
                                <p className="text-gray-600">Make any necessary corrections before generating reports</p>
                            </div>

                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-6">
                                    {error}
                                </div>
                            )}

                            <div className="bg-white rounded-lg shadow overflow-x-auto">
                                <table className="w-full border-collapse">
                                    <thead className="bg-gray-100 border-b-2 border-gray-300">
                                        <tr>
                                            <th className="px-3 py-3 text-left text-sm font-semibold text-gray-700 border-r-2 border-gray-300 sticky left-0 bg-gray-100">
                                                Student Name
                                            </th>
                                            {activities.map((activity, index) => (
                                                <th key={index} className="px-3 py-3 text-center text-sm font-semibold text-gray-700 min-w-[140px]">
                                                    <input
                                                        type="text"
                                                        value={activity}
                                                        onChange={(e) => updateActivityName(index, e.target.value)}
                                                        className="w-full px-2 py-1 border border-gray-300 rounded text-center focus:ring-2 focus:ring-blue-500"
                                                    />
                                                    <button
                                                        onClick={() => deleteActivity(index)}
                                                        className="mt-1 text-xs text-red-600 hover:text-red-800"
                                                    >
                                                        Delete
                                                    </button>
                                                </th>
                                            ))}
                                            <th className="px-3 py-3 text-center text-sm font-semibold text-gray-700">
                                                <button
                                                    onClick={addActivity}
                                                    className="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                                                >
                                                    + Activity
                                                </button>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {students.map((student, studentIndex) => (
                                            <tr key={studentIndex} className="border-b hover:bg-gray-50">
                                                <td className="px-3 py-3 border-r-2 border-gray-300 sticky left-0 bg-white">
                                                    <input
                                                        type="text"
                                                        value={student.name}
                                                        onChange={(e) => updateStudentName(studentIndex, e.target.value)}
                                                        className="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                                        placeholder="Student name"
                                                    />
                                                </td>
                                                {student.grades.map((grade, gradeIndex) => (
                                                    <td key={gradeIndex} className="px-3 py-3 text-center">
                                                        <select
                                                            value={grade}
                                                            onChange={(e) => updateGrade(studentIndex, gradeIndex, e.target.value)}
                                                            className="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 text-center"
                                                        >
                                                            <option value="">-</option>
                                                            <option value="A">A (Excellent)</option>
                                                            <option value="B">B (Good)</option>
                                                            <option value="C">C (Needs Practice)</option>
                                                            <option value="X">X (Absent)</option>
                                                        </select>
                                                    </td>
                                                ))}
                                                <td className="px-3 py-3 text-center">
                                                    <button
                                                        onClick={() => deleteStudent(studentIndex)}
                                                        className="text-red-600 hover:text-red-800 font-medium text-sm"
                                                    >
                                                        Delete
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            <div className="mt-6 flex gap-4 flex-wrap">
                                <button
                                    onClick={addStudent}
                                    className="px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition"
                                >
                                    + Add Student
                                </button>
                                <button
                                    onClick={() => {
                                        setCurrentScreen('upload');
                                        setStudents([]);
                                        setActivities([]);
                                        setUploadedImage(null);
                                    }}
                                    className="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition"
                                >
                                    Start Over
                                </button>
                                <button
                                    onClick={generateReports}
                                    disabled={isProcessing || students.length === 0 || students.some(s => !s.name.trim())}
                                    className="ml-auto px-8 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition"
                                >
                                    {isProcessing ? 'Generating...' : 'Generate Reports'}
                                </button>
                            </div>

                            {isProcessing && (
                                <div className="mt-6 text-center">
                                    <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-600 border-t-transparent"></div>
                                    <p className="mt-2 text-gray-600">Creating personalized reports...</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // Reports Screen
            if (currentScreen === 'reports') {
                return (
                    <div className="min-h-screen bg-gray-50 p-4">
                        <div className="max-w-4xl mx-auto pt-4">
                            <div className="mb-6">
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">Generated Reports</h1>
                                <p className="text-gray-600">Review and download individual student reports</p>
                            </div>

                            <div className="space-y-4">
                                {reports.map((report, index) => (
                                    <div key={index} className="bg-white rounded-lg shadow p-6">
                                        <div className="flex justify-between items-start mb-3">
                                            <h3 className="text-xl font-semibold text-gray-800">{report.studentName}</h3>
                                            <button
                                                onClick={() => downloadReport(report.studentName, report.report)}
                                                className="px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition"
                                            >
                                                Download
                                            </button>
                                        </div>
                                        <div className="text-gray-700 leading-relaxed whitespace-pre-wrap">{report.report}</div>
                                    </div>
                                ))}
                            </div>

                            <div className="mt-8 flex gap-4">
                                <button
                                    onClick={() => {
                                        setCurrentScreen('upload');
                                        setStudents([]);
                                        setActivities([]);
                                        setReports([]);
                                        setUploadedImage(null);
                                    }}
                                    className="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition"
                                >
                                    Process Another Gradesheet
                                </button>
                                <button
                                    onClick={() => setCurrentScreen('edit')}
                                    className="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition"
                                >
                                    Back to Edit
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
